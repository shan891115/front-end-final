<template>
  <div class="min-h-screen flex flex-col bg-green-50">
    <!-- é é ­å€åŸŸ - ä½¿ç”¨ç¶ è‰²ç³»èƒŒæ™¯ -->
    <section class="flex justify-center bg-green-400 text-white py-16">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-4xl font-light mb-6 tracking-tight pb-2">æ—…éŠå»ºè­°</h2>
        <p class="text-xl font-light mb-4 opacity-90">ç²å–ä¾†è‡ªå…¶ä»–æ—…è¡Œè€…å’ŒAIçš„å¯¶è²´å»ºè­°ï¼Œè¦åŠƒå®Œç¾è¡Œç¨‹</p>
      </div>
    </section>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <section class="flex-grow flex justify-center py-20 bg-green-50">
      <div class="container mx-auto px-4 max-w-6xl">
        <h2 class="text-3xl font-light text-center py-4 mb-16 text-emerald-800">ç²å–å°ˆå±¬æ—…éŠå»ºè­°</h2>
        
        <!-- å¾Œç«¯é€£ç·šæç¤º - ä½¿ç”¨æ›´è¼•é‡çš„è¨­è¨ˆ -->
        <div class="bg-teal-50 border-l-4 border-teal-300 text-teal-700 px-6 py-4 rounded-md mb-16 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-teal-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <span class="text-sm">
            <strong>æç¤ºï¼š</strong> è‹¥å¾Œç«¯ä¼ºæœå™¨æœªå•Ÿå‹•ï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ã€‚è‹¥è¦ä½¿ç”¨çœŸå¯¦AIæœå‹™ï¼Œè«‹å…ˆå•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨ã€‚
          </span>
        </div>
        
        <!-- å…¶ä»–ä½¿ç”¨è€…æ¨è–¦ - ä½¿ç”¨å¡ç‰‡å¼è¨­è¨ˆ -->
        <div class="bg-white rounded-xl shadow-sm p-10 mb-20">
          <h3 class="text-2xl font-light mb-10 text-emerald-700 pb-4">æ¢ç´¢æ—…è¡Œè€…æ¨è–¦</h3>
          
          <!-- åœ°å€åˆ†é¡æ¨™ç±¤ - ä½¿ç”¨æ›´ç°¡ç´„çš„æŒ‰éˆ•è¨­è¨ˆ -->
          <div class="flex flex-wrap gap-4 mb-12 pb-4">
            <button 
              v-for="(region, index) in regions" 
              :key="index"
              @click="changeRegion(region.value)"
              :class="[
                'px-6 py-2 rounded-full transition-all text-sm font-medium',
                currentRegion === region.value 
                  ? 'bg-emerald-500 text-white shadow-sm' 
                  : 'bg-green-100 text-emerald-700 hover:bg-green-200'
              ]"
            >
              {{ region.name }}
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-6">
            <!-- ä½¿ç”¨è€…æ¨è–¦ - æ›´ç¾ä»£çš„å¡ç‰‡è¨­è¨ˆ -->
            <div 
              v-for="(recommendation, index) in filteredRecommendations" 
              :key="index"
              class="bg-white rounded-xl border border-green-200 overflow-hidden hover:shadow-md transition-shadow flex flex-col"
            >
              <div class="flex items-start p-6 flex-grow">
                <div class="w-16 h-16 bg-green-200 rounded-full flex-shrink-0 mr-4 overflow-hidden">
                  <!-- ä½¿ç”¨æŠ½è±¡åœ–æ¡ˆæ›¿ä»£ç©ºç™½é ­åƒ -->
                  <div class="w-full h-full bg-green-300"></div>
                </div>
                <div>
                  <h4 class="text-lg font-medium mb-2 text-emerald-800 pl-4">{{ recommendation.name }}</h4>
                  <p class="text-emerald-600 text-sm mb-3 pl-4">{{ recommendation.title }}</p>
                  <p class="text-gray-600 text-sm leading-relaxed pl-4">
                    {{ recommendation.description }}
                  </p>
                </div>
              </div>
              <div class="bg-green-50 p-4 border-t border-green-100 mt-auto">
                <button class="px-4 py-2 bg-emerald-500 text-white text-sm rounded-full hover:bg-emerald-600 transition-colors">
                  æŸ¥çœ‹è¡Œç¨‹è©³æƒ…
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- AIå»ºè­°å€ - æ›´ç¾ä»£çš„è¡¨å–®è¨­è¨ˆ -->
        <div class="bg-white rounded-xl shadow-sm p-10 mb-16">
          <h3 class="text-2xl font-light mb-10 text-emerald-700 pb-4">AIè¡Œç¨‹å»ºè­°</h3>
          
          <form @submit.prevent="handleFormSubmit">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
              <div class="mb-4">
                <label class="block text-emerald-700 text-sm mb-3 font-medium pb-1">æ—…éŠå€åŸŸ</label>
                <select v-model="selectedRegion" @change="updateCountries" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="">è«‹é¸æ“‡å€åŸŸ</option>
                  <option value="asia">äºæ´²</option>
                  <option value="europe">æ­æ´²</option>
                  <option value="america">ç¾æ´²</option>
                  <option value="oceania">å¤§æ´‹æ´²</option>
                  <option value="africa">éæ´²</option>
                </select>
              </div>
              <div class="mb-4">
                <label class="block text-emerald-700 text-sm mb-3 font-medium pb-1">ç›®çš„åœ°åœ‹å®¶</label>
                <select v-model="selectedCountry" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="">{{ countryPlaceholder }}</option>
                  <option v-for="country in availableCountries" :key="country" :value="country">{{ country }}</option>
                </select>
              </div>
              <div class="mb-4">
                <label class="block text-emerald-700 text-sm mb-3 font-medium pb-1">æ—…éŠå¤©æ•¸</label>
                <select v-model="travelDays" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="">è«‹é¸æ“‡å¤©æ•¸</option>
                  <option value="3-5">3-5å¤©</option>
                  <option value="6-8">6-8å¤©</option>
                  <option value="9-12">9-12å¤©</option>
                  <option value="13+">13å¤©ä»¥ä¸Š</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 py-4">
              <div class="mb-4">
                <label class="block text-emerald-700 text-sm mb-3 font-medium py-1">å‡ºç™¼æ—¥æœŸ</label>
                <input type="date" v-model="departureDate" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors">
              </div>
              <div class="mb-4">
                <label class="block text-emerald-700 text-sm mb-3 font-medium py-1">æ—…éŠé¡å‹</label>
                <select v-model="travelType" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors">
                  <option value="">è«‹é¸æ“‡æ—…éŠé¡å‹</option>
                  <option value="family">å®¶åº­æ—…éŠ</option>
                  <option value="honeymoon">èœœæœˆæ—…è¡Œ</option>
                  <option value="adventure">å†’éšªæ—…éŠ</option>
                  <option value="culture">æ–‡åŒ–é«”é©—</option>
                  <option value="food">ç¾é£Ÿä¹‹æ—…</option>
                </select>
              </div>
            </div>
            
            <div class="mb-12">
              <label class="block text-emerald-700 text-sm mb-3 font-medium py-1">ç‰¹åˆ¥éœ€æ±‚æˆ–åå¥½</label>
              <textarea v-model="specialRequirements" class="w-full rounded-lg border border-green-200 px-4 py-3 bg-green-50 text-gray-700 focus:border-emerald-500 focus:ring-0 transition-colors h-32" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç‰¹åˆ¥éœ€æ±‚æˆ–åå¥½..."></textarea>
            </div>
            
            <div class="text-center py-4 pb-6">
              <button 
                type="submit" 
                class="bg-emerald-500 text-white px-10 py-4 rounded-full font-medium hover:bg-emerald-600 transition-all transform hover:scale-105 disabled:opacity-70 disabled:transform-none"
                :disabled="isLoading"
              >
                <span v-if="isLoading" class="flex items-center justify-center">
                  <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  ç”Ÿæˆä¸­...
                </span>
                <span v-else>ç”ŸæˆAIè¡Œç¨‹å»ºè­°</span>
              </button>
            </div>
          </form>
          
          <!-- ç™»å…¥æç¤ºè¨Šæ¯ -->
          <div v-if="showLoginPrompt" class="mt-6 bg-red-50 border-l-4 border-red-400 p-4 mb-8">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-red-700">
                  è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨AIè¡Œç¨‹å»ºè­°åŠŸèƒ½ï¼Œå°‡åœ¨5ç§’å¾Œè·³è½‰è‡³ç™»å…¥é é¢...
                </p>
              </div>
            </div>
          </div>
          
          <!-- AIå›è¦†å€åŸŸ - æ›´å„ªé›…çš„å¡ç‰‡è¨­è¨ˆ -->          
          <div v-if="aiResponse" class="mt-16 border border-green-200 rounded-xl bg-white shadow-sm overflow-hidden">
            <div class="bg-green-100 p-5 border-b border-green-200 flex justify-between items-center">
              <h4 class="text-xl font-medium text-emerald-800">æ‚¨çš„å°ˆå±¬è¡Œç¨‹å»ºè­°</h4>
              <div v-if="selectedCountry" class="text-sm text-emerald-700 bg-white px-3 py-1 rounded-full">
                {{ selectedCountry }} {{ actualDaysCount > 0 ? actualDaysCount : travelDays }}å¤©è¡Œç¨‹
              </div>
            </div>
            <div class="p-8">
              <!-- è¡Œç¨‹ä¸å®Œæ•´è­¦å‘Š -->              <div v-if="showDaysWarning" class="mb-6 rounded-lg bg-amber-50 border-l-4 border-amber-400 p-4">
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm text-amber-700 font-medium">
                      æ‚¨è«‹æ±‚çš„æ˜¯ {{ requestedDaysRange }}ï¼Œä½†AIåƒ…ç”Ÿæˆäº† {{ actualDaysCount }} å¤©çš„è¡Œç¨‹
                    </p>
                    <p class="text-sm text-amber-700 mt-2">æ‚¨å¯ä»¥å˜—è©¦ä¸‹åˆ—æ–¹æ³•å®Œæˆè¡Œç¨‹ï¼š</p>
                    <ul class="text-sm text-amber-700 mt-1 ml-2 space-y-1.5 list-disc list-inside">
                      <li>é»æ“Šã€Œä¿®æ”¹å»ºè­°ã€æŒ‰éˆ•ï¼Œåœ¨ç‰¹åˆ¥éœ€æ±‚ä¸­åŠ å…¥ï¼š<br>
                        <span class="block ml-4 mt-1 italic text-amber-600 bg-amber-50 p-1 rounded border border-amber-200">"è«‹ç¹¼çºŒç”Ÿæˆç¬¬{{ actualDaysCount + 1 }}å¤©åˆ°ç¬¬{{ requestedMinDays }}å¤©çš„è¡Œç¨‹"</span>
                      </li>
                      <li>é‡æ–°ç”Ÿæˆä¸€æ¬¡è¡Œç¨‹å»ºè­°</li>
                      <li v-if="requestedMinDays > 8">å°‡è¡Œç¨‹åˆ†é–‹æŸ¥è©¢ï¼šå…ˆæŸ¥è©¢å‰{{ Math.ceil(requestedMinDays/2) }}å¤©ï¼Œå†æŸ¥è©¢å¾Œ{{ Math.floor(requestedMinDays/2) }}å¤©</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="space-y-4 itinerary-content">
                <div v-html="formattedAiResponse"></div>
              </div>
              <div class="mt-10 flex flex-wrap gap-4 pt-8">
                <button 
                  @click="modifyItinerary" 
                  class="px-6 py-3 bg-white border border-green-300 text-emerald-700 rounded-full hover:bg-green-50 transition-colors text-sm font-medium"
                >
                  ä¿®æ”¹å»ºè­°
                </button>                
                <button 
                  @click="saveItinerary" 
                  class="px-6 py-3 bg-emerald-500 text-white rounded-full hover:bg-emerald-600 transition-colors text-sm font-medium flex items-center"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
                  </svg>
                  å„²å­˜è¡Œç¨‹åˆ°ç€è¦½å™¨
                </button>                
                <button 
                  @click="confirmAndSaveToFirebase"
                  :disabled="isProcessing" 
                  class="px-6 py-3 bg-teal-600 text-white rounded-full hover:bg-teal-700 transition-colors text-sm font-medium flex items-center"
                  :title="extractInfoFromItinerary(aiResponse).country ? 
                          `å°‡è‡ªå‹•æå–è³‡è¨Šï¼š${extractInfoFromItinerary(aiResponse).country} ${extractInfoFromItinerary(aiResponse).days || ''}å¤©è¡Œç¨‹` : 
                          'å„²å­˜è‡³é›²ç«¯ä¸¦æ”¯æ´ç…§ç‰‡ç‰†é—œè¯'"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                  {{ isProcessing ? 'å„²å­˜ä¸­...' : 'ç¢ºèªæ¡ç”¨ä¸¦å„²å­˜è‡³é›²ç«¯' }}
                </button>
              </div>
            </div>
          </div>
          
          <!-- æŸ¥çœ‹å·²å„²å­˜è¡Œç¨‹æŒ‰éˆ• -->
          <div class="mt-12 py-4 pt-6" :class="{ 'pt-4': showLoginPrompt }">
            <button 
              @click="loadSavedItineraries" 
              class="px-6 py-3 bg-white border border-green-300 text-emerald-700 rounded-full hover:bg-green-50 transition-colors text-sm font-medium"
            >
              æŸ¥çœ‹å·²å„²å­˜çš„è¡Œç¨‹
            </button>
          </div>
          
          <!-- å·²å„²å­˜è¡Œç¨‹åˆ—è¡¨ - æ›´ç¾ä»£çš„å¡ç‰‡åˆ—è¡¨ -->
          <div v-if="showSavedItineraries" class="mt-16">
            <h4 class="text-xl font-medium mb-8 text-emerald-800">å·²å„²å­˜çš„è¡Œç¨‹</h4>
            <div v-if="savedItineraries.length === 0" class="p-6 bg-green-50 rounded-lg text-center text-emerald-600">
              å°šæœªä¿å­˜ä»»ä½•è¡Œç¨‹
            </div>
            <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div 
                v-for="itinerary in savedItineraries" 
                :key="itinerary.id" 
                class="p-6 border border-green-200 rounded-xl hover:shadow-md transition-shadow bg-white flex flex-col"
              >
                <div class="flex justify-between items-start flex-grow">
                  <div>
                    <h5 class="font-medium text-emerald-800">{{ itinerary.country }} {{ itinerary.days }}å¤©è¡Œç¨‹</h5>
                    <p class="text-xs text-gray-500 mt-2">å„²å­˜æ—¥æœŸ: {{ itinerary.date }}</p>
                    <div class="flex gap-3 mt-3 py-2">
                      <span class="inline-block px-3 py-1 bg-green-100 text-emerald-700 text-xs rounded-full">{{ itinerary.region }}</span>
                      <span v-if="itinerary.type" class="inline-block px-3 py-1 bg-lime-100 text-emerald-700 text-xs rounded-full">{{ itinerary.type }}</span>
                    </div>
                  </div>
                  <button 
                    @click="deleteItinerary(itinerary.id)" 
                    class="text-emerald-400 hover:text-emerald-600 p-1.5 rounded-full hover:bg-green-50"
                    title="åˆªé™¤è¡Œç¨‹"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
                <div class="mt-6">
                  <button 
                    @click="loadItinerary(itinerary)" 
                    class="px-5 py-2 bg-emerald-500 text-white text-xs rounded-full hover:bg-emerald-600 transition-colors"
                  >
                    æŸ¥çœ‹è¡Œç¨‹
                  </button>
                </div>
              </div>
            </div>
            <div class="mt-8 pt-4">
              <button 
                @click="showSavedItineraries = false" 
                class="px-6 py-3 bg-green-200 text-emerald-700 rounded-full hover:bg-green-300 transition-colors text-sm font-medium"
              >
                é—œé–‰
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<script>
import axios from 'axios';
import { useRouter } from 'vue-router';
import { isAuthenticated } from '../services/authService';
import aiService from '../services/aiService';

export default {
  data() {
    return {
      // æ¨è–¦å€åŸŸç›¸é—œ
      currentRegion: 'asia',
      regions: [
        { name: 'äºæ´²', value: 'asia' },
        { name: 'æ­æ´²', value: 'europe' },
        { name: 'ç¾æ´²', value: 'america' },
        { name: 'å¤§æ´‹æ´²', value: 'oceania' },
        { name: 'éæ´²', value: 'africa' }
      ],
      recommendations: [
        // äºæ´²æ¨è–¦
        { 
          region: 'asia', 
          name: 'ææ˜è¯', 
          title: 'æ—¥æœ¬äº¬éƒ½ä¹‹æ—…',
          description: 'æˆ‘æ¨è–¦æ—¥æœ¬äº¬éƒ½ä½œç‚ºæ–‡åŒ–é«”é©—ä¹‹æ—…ã€‚ç§‹å­£æ¥“è‘‰æˆ–æ˜¥å­£æ«»èŠ±æ™‚ç¯€æœ€ç‚ºç¾éº—ï¼Œå¯ä»¥é«”é©—å‚³çµ±çš„æ—¥æœ¬æ–‡åŒ–ï¼Œåƒè§€å¯ºå»Ÿå’Œé«”é©—èŒ¶é“ã€‚'
        },
        { 
          region: 'asia', 
          name: 'æ—å°æ¢…', 
          title: 'æ–°åŠ å¡å®¶åº­ä¹‹æ—…',
          description: 'æ–°åŠ å¡æ˜¯çµ•ä½³çš„å®¶åº­æ—…éŠç›®çš„åœ°ï¼Œé€™è£¡å®‰å…¨ã€ä¹¾æ·¨ä¸”æœ‰è¨±å¤šé©åˆå…’ç«¥çš„æ™¯é»ï¼Œå¦‚ç’°çƒå½±åŸã€æ°´æ—é¤¨å’Œå‹•ç‰©åœ’ã€‚å…¨å¹´éƒ½é©åˆæ—…è¡Œï¼Œä½†é¿é–‹é›¨å­£ï¼ˆ11æœˆè‡³1æœˆï¼‰ã€‚'
        },
        // æ­æ´²æ¨è–¦
        { 
          region: 'europe', 
          name: 'ç‹ç¾ç', 
          title: 'ç¾©å¤§åˆ©æ‰˜æ–¯å¡ç´ä¹‹æ—…',
          description: 'ç¾©å¤§åˆ©çš„æ‰˜æ–¯å¡ç´åœ°å€æœ‰ç¾éº—çš„é„‰æ‘é¢¨å…‰ã€ä¸–ç•Œç´šçš„ç¾é£Ÿå’Œè‘¡è„é…’ã€‚æœ€å¥½çš„æ—…è¡Œå­£ç¯€æ˜¯æ˜¥å­£å’Œç§‹å­£ï¼Œé¿é–‹ç‚ç†±çš„å¤å­£ã€‚'
        },
        { 
          region: 'europe', 
          name: 'å¼µå¿—æ˜', 
          title: 'æ³•åœ‹å·´é»æµªæ¼«ä¹‹æ—…',
          description: 'å·´é»æ˜¯æµªæ¼«ä¹‹éƒ½ï¼Œè‰¾è²çˆ¾éµå¡”ã€ç¾…æµ®å®®å’Œè–æ¯é™¢ç­‰æ™¯é»ä»¤äººé›£å¿˜ã€‚å»ºè­°æ˜¥å­£æˆ–ç§‹å­£å‰å¾€ï¼Œé¿é–‹å¤å­£çš„éŠå®¢é«˜å³°æœŸã€‚'
        },
        // ç¾æ´²æ¨è–¦
        { 
          region: 'america', 
          name: 'é»ƒå»ºåœ‹', 
          title: 'ç¾åœ‹ç´ç´„åŸå¸‚æ¢ç´¢',
          description: 'ç´ç´„æ˜¯ä¸€åº§å……æ»¿æ´»åŠ›çš„åŸå¸‚ï¼Œå¾ä¸­å¤®å…¬åœ’åˆ°ç™¾è€åŒ¯ï¼Œå¾æ™‚ä»£å»£å ´åˆ°è‡ªç”±å¥³ç¥åƒï¼Œæ¯å€‹æ™¯é»éƒ½å€¼å¾—ä¸€éŠã€‚å»ºè­°æ˜¥å­£æˆ–ç§‹å­£å‰å¾€ï¼Œæ°£å€™å®œäººã€‚'
        },
        { 
          region: 'america', 
          name: 'åŠ‰ç¾ç²', 
          title: 'åŠ æ‹¿å¤§è½åŸºå±±è„ˆä¹‹æ—…',
          description: 'åŠ æ‹¿å¤§è½åŸºå±±è„ˆé¢¨æ™¯å£¯éº—ï¼Œç­èŠ™åœ‹å®¶å…¬åœ’å’Œè³ˆæ–¯ç€åœ‹å®¶å…¬åœ’çš„æ¹–æ³Šå’Œå†°å·ä»¤äººå˜†ç‚ºè§€æ­¢ã€‚å¤å­£æ˜¯æœ€ä½³æ—…éŠå­£ç¯€ã€‚'
        },
        // å¤§æ´‹æ´²æ¨è–¦
        { 
          region: 'oceania', 
          name: 'é™³å¤§è¡›', 
          title: 'ç´è¥¿è˜­å†’éšªä¹‹æ—…',
          description: 'ç´è¥¿è˜­å—å³¶é©åˆå–œæ„›æˆ¶å¤–æ´»å‹•å’Œå£¯éº—è‡ªç„¶é¢¨å…‰çš„æ—…è¡Œè€…ã€‚å¯ä»¥é«”é©—å¾’æ­¥ã€çš®åˆ’è‰‡ã€è·³å‚˜ç­‰æ´»å‹•ï¼Œæœ€ä½³å­£ç¯€æ˜¯ç•¶åœ°çš„å¤å­£ï¼ˆ12æœˆè‡³2æœˆï¼‰ã€‚'
        },
        { 
          region: 'oceania', 
          name: 'å³é›…èŠ³', 
          title: 'æ¾³æ´²æ‚‰å°¼æµ·å²¸ä¹‹æ—…',
          description: 'æ‚‰å°¼æ“æœ‰ç¾éº—çš„æµ·ç˜å’Œæ¨™èªŒæ€§çš„æ­ŒåŠ‡é™¢ï¼Œé©åˆå–œæ„›é™½å…‰å’Œæµ·ç˜çš„æ—…è¡Œè€…ã€‚å»ºè­°åœ¨æ¾³æ´²çš„å¤å­£ï¼ˆ12æœˆè‡³2æœˆï¼‰å‰å¾€ã€‚'
        },
        // éæ´²æ¨è–¦
        { 
          region: 'africa', 
          name: 'é„­ä¸–è±ª', 
          title: 'æ‘©æ´›å“¥æ–‡åŒ–æ¢ç´¢',
          description: 'æ‘©æ´›å“¥æ“æœ‰è±å¯Œçš„æ–‡åŒ–å’Œæ­·å²ï¼Œå¾é¦¬æ‹‰å–€ä»€çš„å¸‚é›†åˆ°æ’’å“ˆæ‹‰æ²™æ¼ çš„ç‡Ÿåœ°ï¼Œæ¯å€‹åœ°æ–¹éƒ½æœ‰ç¨ç‰¹çš„é­…åŠ›ã€‚æ˜¥å­£å’Œç§‹å­£æ˜¯æœ€ä½³æ—…éŠå­£ç¯€ã€‚'
        },
        { 
          region: 'africa', 
          name: 'è”¡ä½³ç²', 
          title: 'å—éé‡ç”Ÿå‹•ç‰©ä¹‹æ—…',
          description: 'å—éçš„å…‹é­¯æ ¼åœ‹å®¶å…¬åœ’æ˜¯è§€è³é‡ç”Ÿå‹•ç‰©çš„çµ•ä½³åœ°é»ï¼Œå¯ä»¥çœ‹åˆ°éæ´²äº”å¤§ç¸ã€‚å»ºè­°åœ¨å—éçš„å†¬å­£ï¼ˆ5æœˆè‡³9æœˆï¼‰å‰å¾€ï¼Œæ­¤æ™‚å‹•ç‰©è¼ƒå®¹æ˜“è¢«ç™¼ç¾ã€‚'
        }
      ],
      
      // AIå»ºè­°ç›¸é—œ
      selectedRegion: '',
      selectedCountry: '',
      travelDays: '',
      departureDate: '',
      travelType: '',
      specialRequirements: '',
      countryPlaceholder: 'è«‹å…ˆé¸æ“‡å€åŸŸ',
      availableCountries: [],      regionCountries: {
        asia: [
          'æ—¥æœ¬', 'éŸ“åœ‹', 'ä¸­åœ‹', 'å°ç£', 'é¦™æ¸¯', 'æ¾³é–€', 'æ–°åŠ å¡', 'é¦¬ä¾†è¥¿äº', 
          'æ³°åœ‹', 'è¶Šå—', 'å°å°¼', 'è²å¾‹è³“', 'å°åº¦', 'æ–¯é‡Œè˜­å¡', 'å°¼æ³Šçˆ¾', 'é¦¬çˆ¾åœ°å¤«',
          'é˜¿è¯é…‹', 'åœŸè€³å…¶'
        ],
        europe: [
          'è‹±åœ‹', 'æ³•åœ‹', 'å¾·åœ‹', 'ç¾©å¤§åˆ©', 'è¥¿ç­ç‰™', 'è‘¡è„ç‰™', 'ç‘å£«', 'å¥§åœ°åˆ©', 
          'è·è˜­', 'æ¯”åˆ©æ™‚', 'å¸Œè‡˜', 'æ·å…‹', 'åŒˆç‰™åˆ©', 'æ³¢è˜­', 'ä¸¹éº¥', 'ç‘å…¸', 
          'æŒªå¨', 'èŠ¬è˜­', 'å†°å³¶', 'æ„›çˆ¾è˜­', 'å…‹ç¾…åŸƒè¥¿äº'
        ],
        america: [
          'ç¾åœ‹', 'åŠ æ‹¿å¤§', 'å¢¨è¥¿å“¥', 'å·´è¥¿', 'é˜¿æ ¹å»·', 'æ™ºåˆ©', 'ç§˜é­¯', 'å“¥å€«æ¯”äº', 
          'å¤å·´', 'ç‰™è²·åŠ ', 'å·´å“ˆé¦¬', 'å“¥æ–¯å¤§é»åŠ '
        ],
        oceania: [
          'æ¾³æ´²', 'ç´è¥¿è˜­', 'æ–æ¿Ÿ', 'å¤§æºªåœ°', 'å¸›ç‰'
        ],
        africa: [
          'åŸƒåŠ', 'æ‘©æ´›å“¥', 'å—é', 'è‚¯äº', 'å¦å°šå°¼äº', 'æ¨¡é‡Œè¥¿æ–¯', 'é¦¬é”åŠ æ–¯åŠ ', 'å¡å¸­çˆ¾'
        ]
      },      actualDaysCount: 0,
      detectedDaysCount: 0,
      mostAccurateDayCount: 0,  // æ–°å¢ï¼šç”¨æ–¼è¨˜éŒ„æœ€å¯é çš„å¯¦éš›å¤©æ•¸è¨ˆç®—
      requestedMinDays: 0,
      requestedMaxDays: 0,
      showDaysWarning: false,
      aiResponse: null,
      isLoading: false,
      isProcessing: false, // è™•ç†ä¿å­˜åˆ°Firebaseçš„ç‹€æ…‹
      apiBaseUrl: 'http://localhost:3333/api', // APIåŸºç¤URLï¼Œä½¿ç”¨èˆ‡æ¯”æ¯”çœ‹ç›¸åŒçš„ç«¯å£
      errorMessage: null,
      savedItineraries: [],
      showSavedItineraries: false,
      showLoginPrompt: false,
      router: useRouter()
    }
  },  
  computed: {
    filteredRecommendations() {
      return this.recommendations.filter(rec => rec.region === this.currentRegion);
    },
    
    formattedAiResponse() {
      if (!this.aiResponse) return '';
      
      try {        // æª¢æŸ¥æ˜¯å¦ç‚ºMarkdownæ ¼å¼
        const hasMarkdown = this.aiResponse.includes('**') || 
                           this.aiResponse.includes('##') || 
                           this.aiResponse.includes('*   ') ||
                           this.aiResponse.includes('---');
        
        if (hasMarkdown) {
          // è™•ç†Markdownæ ¼å¼
          let formatted = this.aiResponse;
          
          // ç§»é™¤Markdownä»£ç¢¼åœæ¬„æ¨™è¨˜
          formatted = formatted.replace(/```markdown\s*/g, '');
          formatted = formatted.replace(/```\s*$/g, '');
          
          // ç§»é™¤éé æœŸçš„æ˜Ÿè™Ÿï¼ˆä½†ä¿ç•™Markdownæ ¼å¼æ¨™è¨˜ï¼‰
          formatted = formatted.replace(/^\* /gm, ''); // ç§»é™¤è¡Œé¦–çš„æ˜Ÿè™Ÿåˆ—è¡¨æ¨™è¨˜
          formatted = formatted.replace(/([^*])\*([^*])/g, '$1$2'); // ç§»é™¤å–®ç¨çš„æ˜Ÿè™Ÿ
            
          // å…ˆè™•ç†ç²—é«”æ¨™è¨˜ï¼Œä»¥é¿å…èˆ‡å…¶ä»–æ ¼å¼è¡çª
          formatted = formatted.replace(/\*\*([^*]*?)\*\*/g, '<strong>$1</strong>');
          
          // è™•ç†"ç¬¬Xå¤©"ç‚ºå¤§æ¨™é¡Œ (æ›´å¤§çš„å­—é«”å’Œé¡¯è‘—æ¨£å¼) - æ”¯æŒå¤šç¨®æ¨™é ­æ ¼å¼
          // æ¨¡å¼1: # ç¬¬Xå¤© (H1) - ä¿®æ­£æ­£å‰‡è¡¨é”å¼ï¼Œé¿å…åŒ¹é…åˆ°å¾ŒçºŒçš„ ## æ¨™é¡Œ
          formatted = formatted.replace(/^# ç¬¬(\d+)å¤©\s*(?:\(([^)]*)\))?(?:\s*[-â€“:ï¼š]?\s*([^#]*?))?(?=\n|$)/gm, 
            (match, day, location, desc) => {
              let title = `ç¬¬${day}å¤©`;
              if (location) title += ` (${location})`;
              if (desc && desc.trim() && !desc.includes('##')) title += ` - ${desc.trim()}`;
              return `<h1 class="text-3xl font-bold mt-12 pt-6 mb-6 py-3 border-b-2 border-emerald-500 text-emerald-800">${title}</h1>`;
            });
          
          // æ¨¡å¼2: ## ç¬¬Xå¤© (H2è½‰æˆH1) - åŒæ¨£ä¿®æ­£
          formatted = formatted.replace(/^## ç¬¬(\d+)å¤©\s*(?:\(([^)]*)\))?(?:\s*[-â€“:ï¼š]?\s*([^#]*?))?(?=\n|$)/gm, 
            (match, day, location, desc) => {
              let title = `ç¬¬${day}å¤©`;
              if (location) title += ` (${location})`;
              if (desc && desc.trim() && !desc.includes('##')) title += ` - ${desc.trim()}`;
              return `<h1 class="text-3xl font-bold mt-12 pt-6 mb-6 py-3 border-b-2 border-emerald-500 text-emerald-800">${title}</h1>`;
            });
            
          // è™•ç†ä¸­æ¨™é¡Œ - "è¡Œç¨‹"ã€"ä½å®¿å»ºè­°"ã€"ç”¨é¤æ¨è–¦"ç­‰
          formatted = formatted.replace(/^## ([^#].*?)[:ï¼š]?(?=\n|$)/gm, 
            '<h2 class="text-2xl font-semibold my-4 text-emerald-700">$1</h2>');
            
          // è™•ç†å°æ¨™é¡Œ (å¦‚æœæœ‰çš„è©±)
          formatted = formatted.replace(/^### ([^#].*?)(?=\n|$)/gm, 
            '<h3 class="text-xl font-medium my-3 text-emerald-600">$1</h3>');
          
          // å„ªåŒ–å…§å®¹æ›è¡Œè™•ç†          // è™•ç†æ™‚æ®µå’Œç›¸é—œå…§å®¹
          // å…ˆè™•ç†å‰ç½®è©ç‚ºä¸»è©ä¸”æ²’æœ‰æ¥å¾Œç½®è©çš„æƒ…æ³
          formatted = formatted.replace(/(?<![æ™šæ—©åˆ])(?:^|\n|\<br\>|\. |ã€‚)(æ—©é¤|åˆé¤|ä¸Šåˆ|ä¸‹åˆ|æ—©ä¸Š|æ—©æ™¨|å‚æ™š|ä¸­åˆ|é»ƒæ˜)[:ï¼š]/g, 
            '<br><strong class="text-emerald-600">$1ï¼š</strong>');
          
          // ç‰¹æ®Šè™•ç†"æ™šé¤"å’Œ"æ™šä¸Š"ï¼Œé¿å…åˆ‡å‰²"å‚æ™šï¼šå‰å¾€...æ™šé¤"é€™é¡å¥å­
          formatted = formatted.replace(/(?<![å‚é»ƒ])(?:^|\n|\<br\>|\. |ã€‚)(æ™šé¤|æ™šä¸Š)[:ï¼š]/g, 
            '<br><strong class="text-emerald-600">$1ï¼š</strong>');
            
          // è™•ç†ä½å®¿ã€äº¤é€šç­‰é …ç›®
          formatted = formatted.replace(/(ä½å®¿|äº¤é€š|æ³¨æ„äº‹é …|å°å»ºè­°|å»ºè­°)[:ï¼š]/g, 
            '<br><strong class="text-emerald-600">$1ï¼š</strong>');
            // åœ¨å¥è™Ÿã€é©šå˜†è™Ÿã€å•è™Ÿå¾Œé©ç•¶æ›è¡Œï¼Œä½†è¦æ³¨æ„ä¸è¦åˆ‡å‰²é€£çºŒçš„è©èª
          formatted = formatted.replace(/([ã€‚ï¼ï¼Ÿ])(\s*)(?<![æ™šå‚é»ƒ])(æ—©é¤|åˆé¤|ä¸Šåˆ|ä¸‹åˆ|æ—©ä¸Š|æ—©æ™¨|ä¸­åˆ|ä½å®¿|äº¤é€š|æ³¨æ„äº‹é …)/g, 
            '$1<br><strong class="text-emerald-600">$3ï¼š</strong>');
          
          // ç‰¹åˆ¥è™•ç†å¯èƒ½è¢«éŒ¯èª¤åˆ†å‰²çš„"æ™šé¤"ã€"æ™šä¸Š"ã€"å‚æ™š"
          formatted = formatted.replace(/([ã€‚ï¼ï¼Ÿ])(\s*)(?<![å‚é»ƒ])(æ™šé¤|æ™šä¸Š)/g, 
            '$1<br><strong class="text-emerald-600">$3ï¼š</strong>');
          formatted = formatted.replace(/([ã€‚ï¼ï¼Ÿ])(\s*)(å‚æ™š|é»ƒæ˜)/g, 
            '$1<br><strong class="text-emerald-600">$3ï¼š</strong>');
            
          // é¡å¤–ä¿®å¾©ï¼šè™•ç†"å‚æ™šï¼š...æ™šé¤"çš„æƒ…æ³ï¼ŒæŠŠèª¤åŠ çš„æ¨™ç±¤ç§»é™¤
          formatted = formatted.replace(/<strong class="text-emerald-600">å‚æ™šï¼š<\/strong>(.*?)<br><strong class="text-emerald-600">æ™šé¤ï¼š<\/strong>/g, 
            '<strong class="text-emerald-600">å‚æ™šï¼š</strong>$1æ™šé¤');
          
          // æ·»åŠ ï¼šæŠŠè¡Œç¨‹ä¸­çš„é‡é»æ™¯é»è½‰æ›ç‚ºç¶ è‰²ç²—é«”å­—
          // å…ˆæ‰¾å‡ºè¡Œç¨‹éƒ¨åˆ†ï¼Œå†è™•ç†å…§éƒ¨çš„é‡é»æ™¯é»
          let inItinerarySection = false;
          const lines = formatted.split('\n');
          const resultLines = [];
          
          for (const line of lines) {
            // æª¢æŸ¥æ˜¯å¦é€²å…¥æˆ–é›¢é–‹è¡Œç¨‹éƒ¨åˆ†
            if (line.includes('<h2 class="') && (line.includes('è¡Œç¨‹') || line.includes('itinerary'))) {
              inItinerarySection = true;
              resultLines.push(line);
              continue;
            } else if (line.includes('<h2 class="') || line.includes('<h1 class="')) {
              inItinerarySection = false;
              resultLines.push(line);
              continue;
            }
              
            // å¦‚æœåœ¨è¡Œç¨‹éƒ¨åˆ†ï¼Œè™•ç†é‡é»æ™¯é»
            if (inItinerarySection) {
              // å°‹æ‰¾å·²ç¶“æ˜¯ç²—é«”çš„æ™¯é»åç¨±
              let processedLine = line.replace(
                /<strong>(.*?(?:æ™¯é»|å¤è¹Ÿ|åšç‰©é¤¨|å…¬åœ’|å¯ºå»Ÿ|ç¥ç¤¾|åŸå ¡|å®®æ®¿|æ•™å ‚|å¤§å»ˆ|å¡”|æ¹–æ³Š|å±±è„ˆ|æµ·ç˜|ç€‘å¸ƒ).*?)<\/strong>/g, 
                '<strong class="text-green-600 font-bold">$1</strong>'
              );
              
              // å°‹æ‰¾åˆ—è¡¨é …ä¸­çš„æ™¯é»åç¨±ï¼ˆä¸å¸¶ç²—é«”æ¨™è¨˜ï¼‰
              processedLine = processedLine.replace(
                /(\* |â€¢ |&bull; |<li>)([^<:ï¼š]*?(?:æ™¯é»|å¤è¹Ÿ|åšç‰©é¤¨|å…¬åœ’|å¯ºå»Ÿ|ç¥ç¤¾|åŸå ¡|å®®æ®¿|æ•™å ‚|å¤§å»ˆ|å¡”|æ¹–æ³Š|å±±è„ˆ|æµ·ç˜|ç€‘å¸ƒ)[^<:ï¼š]*?)([ï¼š:]|<|$)/g,
                '$1<span class="text-green-600 font-bold">$2</span>$3'
              );
              
              resultLines.push(processedLine);
            } else {
              resultLines.push(line);
            }
          }
          
          formatted = resultLines.join('\n');
          return formatted;
          
        } else {
          // è™•ç†éMarkdownæ ¼å¼
          let formatted = this.aiResponse;
          
          // ç§»é™¤éé æœŸçš„æ˜Ÿè™Ÿ
          formatted = formatted.replace(/^\* /gm, ''); // ç§»é™¤è¡Œé¦–çš„æ˜Ÿè™Ÿ
          formatted = formatted.replace(/([^*\s])\*([^*\s])/g, '$1$2'); // ç§»é™¤å…§å®¹ä¸­çš„å–®ç¨æ˜Ÿè™Ÿ
          
          // åŸºæœ¬æ›è¡Œè™•ç†
          formatted = formatted.replace(/\n/g, '<br>');
          
          // "ç¬¬Xå¤©"ç‚ºå¤§æ¨™é¡Œ
          formatted = formatted.replace(/ç¬¬(\d+)å¤©/g, 
            '<h2 class="text-2xl font-bold mt-12 pt-6 mb-6 py-2 border-b-2 border-emerald-500 text-emerald-800">ç¬¬$1å¤©</h2>');
          
          // å°‡"è¡Œç¨‹"ã€"ä½å®¿"ã€"ç”¨é¤"ç­‰è©èªä½œç‚ºä¸­æ¨™é¡Œè™•ç†
          formatted = formatted.replace(/(è¡Œç¨‹|ä½å®¿å»ºè­°|ä½å®¿æ¨è–¦|ç”¨é¤å»ºè­°|ç”¨é¤æ¨è–¦|æ™¯é»æ¨è–¦|äº¤é€šæ–¹å¼|å°å»ºè­°)ï¼š/g,
            '<h3 class="text-xl font-semibold mt-6 mb-3 text-emerald-700">$1</h3>');
          
          // å„ªåŒ–ç”¨é¤æ™‚æ®µçš„æ›è¡Œé¡¯ç¤º
          formatted = formatted.replace(/(æ—©é¤|åˆé¤|æ™šé¤)[:ï¼š]/g, 
            '<br><div class="mt-2 mb-2"><strong class="text-emerald-600">$1ï¼š</strong></div>');
          
          // å„ªåŒ–å…¶ä»–é …ç›®çš„æ›è¡Œé¡¯ç¤º
          formatted = formatted.replace(/(ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š|æ—©ä¸Š|æ—©æ™¨|å‚æ™š|ä¸­åˆ|é»ƒæ˜)[:ï¼š]/g, 
            '<br><div class="mt-2 mb-1"><strong class="text-emerald-600">$1ï¼š</strong></div>');
          
          // ä½å®¿ã€äº¤é€šç­‰é …ç›®æ›è¡Œ
          formatted = formatted.replace(/(ä½å®¿|äº¤é€š|æ³¨æ„äº‹é …)[:ï¼š]/g, 
            '<br><div class="mt-2 mb-1"><strong class="text-emerald-600">$1ï¼š</strong></div>');
          
          // åœ¨å¥è™Ÿå¾Œé©ç•¶å¢åŠ æ›è¡Œï¼Œè®“å…§å®¹æ›´æ˜“é–±è®€
          formatted = formatted.replace(/([ã€‚ï¼ï¼Ÿ])(\s*)(æ—©é¤|åˆé¤|æ™šé¤|ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š|æ—©ä¸Š|ä½å®¿|äº¤é€š)/g, 
            '$1<br><div class="mt-2 mb-1"><strong class="text-emerald-600">$3ï¼š</strong></div>');
          
          return formatted;
        }
      } catch (error) {
        console.error('æ ¼å¼åŒ–AIå›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        // ç™¼ç”ŸéŒ¯èª¤æ™‚è¿”å›åŸå§‹å›æ‡‰ï¼Œä¸¦ç§»é™¤æ˜Ÿè™Ÿ
        let fallback = this.aiResponse.replace(/^\* /gm, '').replace(/\n/g, '<br>');
        return fallback;
      }
    }
  },
  methods: {
    changeRegion(region) {
      this.currentRegion = region;
    },
    updateCountries() {
      if (this.selectedRegion) {
        this.availableCountries = this.regionCountries[this.selectedRegion];
        this.countryPlaceholder = 'è«‹é¸æ“‡åœ‹å®¶';
      } else {
        this.availableCountries = [];
        this.countryPlaceholder = 'è«‹å…ˆé¸æ“‡å€åŸŸ';
      }
      this.selectedCountry = '';
    },
    async generateItinerary() {
      if (!this.selectedRegion || !this.selectedCountry || !this.travelDays) {
        alert('è«‹è‡³å°‘é¸æ“‡æ—…éŠå€åŸŸã€ç›®çš„åœ°åœ‹å®¶å’Œæ—…éŠå¤©æ•¸');
        return;
      }      this.isLoading = true;
      this.errorMessage = null;
      this.aiResponse = null;
      this.detectedDaysCount = 0; // é‡ç½®æª¢æ¸¬åˆ°çš„å¤©æ•¸
      
      // è§£æä¸¦è¨­ç½®è«‹æ±‚çš„å¤©æ•¸ç¯„åœ
      const dayRange = this.travelDays.split('-');
      this.requestedMinDays = parseInt(dayRange[0]) || 0;
      this.requestedMaxDays = dayRange.length > 1 ? parseInt(dayRange[1]) : this.requestedMinDays;
      
      console.log(`è«‹æ±‚çš„å¤©æ•¸ç¯„åœ: ${this.requestedMinDays}-${this.requestedMaxDays}å¤©`)
      
      try {
        try {
          console.log('æ­£åœ¨èª¿ç”¨APIç”Ÿæˆè¡Œç¨‹...');
          
          const response = await axios.post(`${this.apiBaseUrl}/ai/itinerary`, {
            region: this.selectedRegion,
            country: this.selectedCountry,
            days: this.travelDays,
            departureDate: this.departureDate,
            travelType: this.travelType,
            specialRequirements: this.specialRequirements,
            // æ–°å¢ï¼šè¦æ±‚å®Œæ•´å›æ‡‰çš„åƒæ•¸
            requestComplete: true,
            maxLength: 4000 // å»ºè­°å¾Œç«¯è¨­ç½®åˆé©çš„æœ€å¤§é•·åº¦
          }, {
            timeout: 120000, // å¢åŠ åˆ°2åˆ†é˜
            maxContentLength: Infinity,
            maxBodyLength: Infinity
          });
            console.log('APIå®Œæ•´å›æ‡‰:', response.data);
          
          if (response.data && response.data.success) {
            // è™•ç†æ–°çš„APIæ ¼å¼ï¼Œdata.data.itineraryåŒ…å«è¡Œç¨‹å…§å®¹
            const aiMessage = response.data.data?.itinerary || response.data.message;
            console.log('å›æ‡‰é•·åº¦:', aiMessage?.length);
            
            // ä¿å­˜å…ƒæ•¸æ“šä»¥ä¾›å¾ŒçºŒä½¿ç”¨
            const metadata = response.data.data?.metadata || {};
            console.log('å›æ‡‰å…ƒæ•¸æ“š:', metadata);
            
            // æª¢æŸ¥å›æ‡‰æ˜¯å¦è¢«æˆªæ–·
            const isTruncated = this.checkIfTruncated(aiMessage);
            
            // è®Šæ•¸ä¾†å„²å­˜è™•ç†å¾Œçš„å›æ‡‰
            let processedResponse = aiMessage;
            
            if (isTruncated) {
              console.warn('æª¢æ¸¬åˆ°AIå›æ‡‰è¢«æˆªæ–­');
              
              // å˜—è©¦è«‹æ±‚ç¹¼çºŒç”Ÿæˆ
              processedResponse = await this.requestContinuation(aiMessage);
            } else {
              console.log('AIå›æ‡‰çœ‹èµ·ä¾†å®Œæ•´');
            }
            
            // åŸ·è¡Œè³ªé‡æª¢æŸ¥
            const qualityCheck = this.validateResponseQuality(processedResponse);
            
            if (!qualityCheck.isValid) {
              console.warn('AIå›æ‡‰è³ªé‡æª¢æŸ¥ç™¼ç¾å•é¡Œ:', qualityCheck.issues);
              
              // æ ¹æ“šè³ªé‡å•é¡Œèª¿æ•´å›æ‡‰
              if (qualityCheck.issues.includes('å›æ‡‰å…§å®¹éçŸ­')) {
                console.log('å›æ‡‰éçŸ­ï¼Œå˜—è©¦å¢åŠ å…§å®¹');
                // å¦‚æœå›æ‡‰éçŸ­ï¼Œå˜—è©¦å†æ¬¡ç”Ÿæˆæˆ–å¢å¼·ç¾æœ‰å…§å®¹
                processedResponse = this.enhanceShortResponse(processedResponse);
              }
              
              // è™•ç†æœªé–‰åˆçš„Markdownæ¨™è¨˜
              if (qualityCheck.issues.some(issue => issue.includes('æœªé–‰åˆ'))) {
                console.log('ä¿®å¾©æœªé–‰åˆçš„Markdownæ¨™è¨˜');
                processedResponse = this.fixUnclosedMarkdown(processedResponse);
              }
            }
              this.aiResponse = processedResponse;
            console.log('æœ€çµ‚è™•ç†å¾Œçš„å›æ‡‰é•·åº¦:', processedResponse.length);
            
            // æ›´æ–°å¤©æ•¸è¨ˆç®—å’Œè­¦å‘Šç‹€æ…‹
            this.updateDaysCountAndWarning();
            
            return;
          } else {
            throw new Error('APIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }
        } catch (apiError) {
          console.error('APIé€£ç·šè©³ç´°éŒ¯èª¤:', apiError);
          this.handleApiError(apiError);
        }
        
        // å‚™é¸æ–¹æ¡ˆï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™
        console.log('ä½¿ç”¨å®Œæ•´çš„æ¨¡æ“¬è¡Œç¨‹è³‡æ–™');
        await new Promise(resolve => setTimeout(resolve, 800));
        this.generateCompleteMockResponse();
        
      } catch (error) {
        console.error('ç”Ÿæˆè¡Œç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        this.errorMessage = `ç”Ÿæˆè¡Œç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
        alert(this.errorMessage);
      } finally {
        this.isLoading = false;
      }
    },    // æ”¹é€²çš„æˆªæ–·æª¢æ¸¬æ–¹æ³•
    checkIfTruncated(response) {
      // ç©ºå›æ‡‰æˆ–å¤ªçŸ­çš„å›æ‡‰è¦–ç‚ºæˆªæ–·
      if (!response) {
        console.warn('å›æ‡‰ç‚ºç©ºï¼Œè¦–ç‚ºæˆªæ–·');
        return true;
      }
      
      if (response.length < 200) {
        console.warn('å›æ‡‰é•·åº¦ä¸è¶³ï¼Œè¦–ç‚ºæˆªæ–·');
        return true;
      }
      
      // æª¢æŸ¥å›æ‡‰ä¸­çš„å¤©æ•¸æ˜¯å¦èˆ‡è«‹æ±‚çš„å¤©æ•¸åŒ¹é…
      const dayRange = this.travelDays.split('-');
      const minDays = parseInt(dayRange[0]);
      const maxDays = dayRange.length > 1 ? parseInt(dayRange[1]) : minDays;      // è¨ˆç®—å›æ‡‰ä¸­åŒ…å«çš„å¤©æ•¸ (æ“´å¤§æª¢æ¸¬ç¯„åœï¼ŒåŒ…æ‹¬å„ç¨®ä¸åŒæ ¼å¼)
      // å¸¸è¦‹çš„æ—¥æ¨™é¡Œæ ¼å¼ï¼š
      // 1. # ç¬¬Xå¤© (åœ°é») 
      // 2. ## ç¬¬Xå¤© (åœ°é»)
      // 3. ç¬¬Xå¤©ï¼ˆåœ°é»ï¼‰
      // 4. ç¬¬Xå¤©ï¼šåœ°é»
      const h1DayMatches = response.match(/# ç¬¬\d+å¤©/g) || [];
      const h2DayMatches = response.match(/## ç¬¬\d+å¤©/g) || [];
      const plainDayMatches = response.match(/ç¬¬\d+å¤©[^#]/g) || []; // ä¸å¸¶#è™Ÿçš„å¤©æ•¸æ¨™è¨˜
      
      // ä¹Ÿæª¢æŸ¥æ˜¯å¦æœ‰ä½¿ç”¨æ•¸å­—æ¨™è™Ÿçš„æ–¹å¼ï¼šDay 1, Day 2 ç­‰
      const englishDayMatches = response.match(/Day\s+\d+/gi) || [];
      
      // åˆè¨ˆæ‰€æœ‰åµæ¸¬åˆ°çš„ä¸åŒæ ¼å¼å¤©æ•¸
      const totalDayMatches = h1DayMatches.length + h2DayMatches.length + 
                             plainDayMatches.length + englishDayMatches.length;
      
      // æ›´å¥½çš„æ–¹æ³•ï¼šæ‰¾å‡ºæ‰€æœ‰æåˆ°çš„å¤©æ•¸ç·¨è™Ÿï¼Œå–æœ€å¤§å€¼
      const allDayNumbers = [];
      
      // å¾å„ç¨®æ ¼å¼ä¸­æå–å¤©æ•¸
      h1DayMatches.forEach(match => {
        const num = parseInt(match.match(/\d+/)[0]);
        allDayNumbers.push(num);
      });
      
      h2DayMatches.forEach(match => {
        const num = parseInt(match.match(/\d+/)[0]);
        allDayNumbers.push(num);
      });
      
      plainDayMatches.forEach(match => {
        const num = parseInt(match.match(/\d+/)[0]);
        allDayNumbers.push(num);
      });
      
      englishDayMatches.forEach(match => {
        const num = parseInt(match.match(/\d+/)[0]);
        allDayNumbers.push(num);
      });
      
      // æ‰¾å‡ºæœ€å¤§å¤©æ•¸
      const maxDayDetected = allDayNumbers.length > 0 ? Math.max(...allDayNumbers) : 0;
      
      // æ ¹æ“šåµæ¸¬çµæœæ±ºå®šå¯¦éš›å¤©æ•¸
      const actualDaysCount = Math.max(totalDayMatches, maxDayDetected);
      
      console.log('åµæ¸¬åˆ°è¡Œç¨‹å¤©æ•¸æ®µè½:', totalDayMatches, 
                  '(H1æ ¼å¼:', h1DayMatches.length, 
                  ', H2æ ¼å¼:', h2DayMatches.length,
                  ', ç´”æ–‡å­—:', plainDayMatches.length,
                  ', è‹±æ–‡Day:', englishDayMatches.length,
                  ')');
      console.log('åµæ¸¬åˆ°çš„æ‰€æœ‰å¤©æ•¸ç·¨è™Ÿ:', allDayNumbers, 'æœ€å¤§å¤©æ•¸:', maxDayDetected);
        // å„²å­˜å¯¦éš›åµæ¸¬åˆ°çš„å¤©æ•¸ï¼Œå–æœ€å¤§å¯èƒ½çš„å¤©æ•¸
      // ç¢ºä¿æˆ‘å€‘å„²å­˜ç¢ºå¯¦åµæ¸¬åˆ°çš„å¤©æ•¸ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è«‹æ±‚çš„æœ€å¤§å¤©æ•¸ä½œç‚ºé è¨­å€¼
      this.detectedDaysCount = actualDaysCount > 0 ? actualDaysCount : (this.requestedMaxDays || 0);
      console.log(`è¨­ç½®åµæ¸¬åˆ°çš„å¤©æ•¸: ${this.detectedDaysCount} (å¯¦éš›=${actualDaysCount}, è«‹æ±‚æœ€å¤§=${this.requestedMaxDays})`);
      
      // æ›´æ–°ï¼šæ·»åŠ ä¸­é–“å€¼ï¼Œç”¨æ–¼è¨˜éŒ„æœ€å¯é çš„å¯¦éš›å¤©æ•¸è¨ˆç®—
      this.mostAccurateDayCount = maxDayDetected > totalDayMatches ? maxDayDetected : totalDayMatches;
        // å°æ–¼ç¯„åœå¤©æ•¸ï¼ˆå¦‚3-5å¤©ï¼‰ï¼Œåªè¦å¯¦éš›å¤©æ•¸é”åˆ°äº†ç¯„åœçš„æœ€å°å€¼å³å¯è¦–ç‚ºå®Œæ•´
      if (maxDays > minDays) {
        // å¦‚æœæ˜¯å¤©æ•¸ç¯„åœï¼ˆå¦‚3-5å¤©ï¼‰ï¼Œåªè¦å¯¦éš›å¤©æ•¸å¤§æ–¼ç­‰æ–¼æœ€å°å€¼å³å¯æ¥å—
        if (actualDaysCount < minDays) {
          console.warn(`å›æ‡‰åƒ…åŒ…å«${actualDaysCount}å¤©ï¼Œè€Œä¸æ˜¯æœŸæœ›çš„è‡³å°‘${minDays}å¤©ï¼Œå¯èƒ½è¢«æˆªæ–·`);
          return true;
        } else {
          // å·²é”åˆ°æœ€å°å¤©æ•¸è¦æ±‚
          console.log(`å›æ‡‰åŒ…å«${actualDaysCount}å¤©ï¼Œå·²æ»¿è¶³æœŸæœ›çš„æœ€å°å¤©æ•¸${minDays}å¤©`);
        }
      } else {
        // å¦‚æœæ˜¯å›ºå®šå¤©æ•¸ï¼ˆå¦‚5å¤©ï¼‰ï¼Œéœ€è¦å®Œå…¨åŒ¹é…
        if (actualDaysCount < minDays) {
          console.warn(`å›æ‡‰åƒ…åŒ…å«${actualDaysCount}å¤©ï¼Œè€Œä¸æ˜¯æœŸæœ›çš„${minDays}å¤©ï¼Œå¯èƒ½è¢«æˆªæ–·`);
          return true;
        }
      }
      
      const trimmedResponse = response.trim();
      const lastChar = trimmedResponse.slice(-1);
      const last20Chars = trimmedResponse.slice(-20);
      const last50Chars = trimmedResponse.slice(-50);
      const last100Chars = trimmedResponse.slice(-100);
      
      console.log('æª¢æŸ¥æˆªæ–· - æœ€å¾Œå­—å…ƒ:', lastChar);
      console.log('æª¢æŸ¥æˆªæ–· - æœ€å¾Œ20å­—:', last20Chars);
      
      // 1. æª¢æŸ¥æ˜¯å¦ä»¥å®Œæ•´å¥å­çµå°¾ï¼ˆä¸­æ–‡å¥è™Ÿã€è‹±æ–‡å¥è™Ÿã€æ„Ÿå˜†è™Ÿã€å•è™Ÿï¼‰
      const properEndings = ['ã€‚', '.', 'ï¼', '!', 'ï¼Ÿ', '?', 'âœˆï¸', 'ğŸ‰'];
      const endsWithProperPunctuation = properEndings.some(ending => 
        trimmedResponse.endsWith(ending)
      );
      
      // å¦‚æœä»¥åˆé©çš„æ¨™é»çµå°¾ï¼Œå¯èƒ½æ˜¯å®Œæ•´çš„
      if (endsWithProperPunctuation) {
        // ä½†é‚„éœ€è¦æª¢æŸ¥æ˜¯å¦åœ¨å¥å­ä¸­é–“è¢«æˆªæ–·
        const beforePunctuation = trimmedResponse.slice(-10, -1);
        
        // å¦‚æœæ¨™é»ç¬¦è™Ÿå‰çš„å…§å®¹çœ‹èµ·ä¾†ä¸å®Œæ•´ï¼Œä»ç„¶å¯èƒ½æ˜¯æˆªæ–·
        const incompletePhrases = [
          /é€™æ˜¯ä¸€å€‹[^ã€‚]*$/,
          /å¯ä»¥[^ã€‚]*$/,
          /å»ºè­°[^ã€‚]*$/,
          /å‰å¾€[^ã€‚]*$/,
          /æ­ä¹˜[^ã€‚]*$/,
          /åƒè§€[^ã€‚]*$/
        ];
        
        const hasIncompletePhrase = incompletePhrases.some(pattern => 
          pattern.test(beforePunctuation)
        );
        
        if (hasIncompletePhrase) {
          console.log('æª¢æ¸¬åˆ°ä¸å®Œæ•´çš„çŸ­èªï¼Œå¯èƒ½è¢«æˆªæ–·');
          return true;
        }
        
        return false; // çœ‹èµ·ä¾†æ˜¯å®Œæ•´çš„
      }
      
      // 2. æ˜é¡¯çš„æˆªæ–·æ¨¡å¼æª¢æ¸¬
      const definitelyTruncatedPatterns = [
        // æ–‡å­—åœ¨å–®è©/å¥å­ä¸­é–“è¢«åˆ‡æ–·
        /[é€™æ˜¯ä¸€å€‹å½ˆ]$/, // åƒæ‚¨ä¾‹å­ä¸­çš„"å½ˆ"å­—
        /[^ã€‚ï¼ï¼Ÿ\s][a-zA-Z]$/, // è‹±æ–‡å–®è©è¢«æˆªæ–·
        /\*\s*$/, // åˆ—è¡¨é …ç›®é–‹å§‹ä½†æ²’æœ‰å…§å®¹
        /[:ï¼š]\s*$/, // å†’è™Ÿå¾Œæ²’æœ‰å…§å®¹
        /[,ï¼Œ]\s*$/, // é€—è™Ÿå¾Œæ²’æœ‰å…§å®¹
        /ç¬¬\d+å¤©[ï¼š:]*\s*$/, // "ç¬¬Xå¤©ï¼š"å¾Œæ²’æœ‰å…§å®¹
        /\*\*[^*]*$/, // æœªé–‰åˆçš„ç²—é«”æ¨™è¨˜
        /##[^#\n]*$/, // æœªé–‰åˆçš„æ¨™é¡Œ
        /[å‰å¾€|æ­ä¹˜|æŠµé”|åƒè§€|å¯ä»¥|å»ºè­°|éœ€è¦|æ‡‰è©²][^ã€‚ï¼ï¼Ÿ]*$/, // å‹•ä½œè©å¾Œæ²’æœ‰å®Œæˆ
        /æ³¨æ„äº‹é …\s*[ï¼š:]*\s*\*?\s*$/, // "æ³¨æ„äº‹é …ï¼š"å¾Œæ²’æœ‰å…§å®¹
        /[å»ºè­°|æ¨è–¦|æé†’][^ã€‚]*[é€™|æ‚¨|å¯][^ã€‚]*$/, // å»ºè­°å¥å­æ²’æœ‰å®Œæˆ
        /[è³¼è²·|é¸æ“‡|å‰å¾€][^ã€‚]*$/, // å‹•ä½œæ²’æœ‰å®Œæˆ
        /\s+$/ // åªæœ‰ç©ºç™½å­—ç¬¦çµå°¾ä¹Ÿå¯èƒ½æ˜¯æˆªæ–·
      ];
      
      const isTruncated = definitelyTruncatedPatterns.some(pattern => {
        const match = pattern.test(last100Chars);
        if (match) {
          console.log('åŒ¹é…åˆ°æˆªæ–·æ¨¡å¼:', pattern.source);
          console.log('åŒ¹é…çš„æ–‡å­—:', last100Chars.match(pattern)?.[0]);
        }
        return match;
      });
      
      // 3. çµæ§‹å®Œæ•´æ€§æª¢æŸ¥
      if (!isTruncated) {
        // æª¢æŸ¥Markdownçµæ§‹æ˜¯å¦å®Œæ•´
        const unclosedMarkdown = [
          /\*\*[^*]*$/, // æœªé–‰åˆçš„ç²—é«”
          /\*[^*\n]*$/, // æœªé–‰åˆçš„æ–œé«”
          /#{1,6}[^#\n]*$/, // æœªé–‰åˆçš„æ¨™é¡Œ
          /```[^`]*$/, // æœªé–‰åˆçš„ä»£ç¢¼å¡Š
          /\[[^\]]*$/, // æœªé–‰åˆçš„é€£çµ
          /\([^)]*$/ // æœªé–‰åˆçš„æ‹¬è™Ÿ
        ];
        
        if (unclosedMarkdown.some(pattern => pattern.test(last50Chars))) {
          console.log('æª¢æ¸¬åˆ°æœªé–‰åˆçš„Markdownçµæ§‹');
          return true;
        }
      }
      
      // 4. èªç¾©å®Œæ•´æ€§æª¢æŸ¥
      if (!isTruncated) {
        // æª¢æŸ¥æ˜¯å¦åœ¨é‡è¦ä¿¡æ¯ä¸­é–“è¢«æˆªæ–·
        const semanticIncomplete = [
          /è²»ç”¨[ï¼š:][^ã€‚]*$/, // è²»ç”¨ä¿¡æ¯æ²’å®Œæˆ
          /æ™‚é–“[ï¼š:][^ã€‚]*$/, // æ™‚é–“ä¿¡æ¯æ²’å®Œæˆ
          /åœ°å€[ï¼š:][^ã€‚]*$/, // åœ°å€ä¿¡æ¯æ²’å®Œæˆ
          /é›»è©±[ï¼š:][^ã€‚]*$/, // é›»è©±ä¿¡æ¯æ²’å®Œæˆ
          /åƒ¹æ ¼[ï¼š:][^ã€‚]*$/, // åƒ¹æ ¼ä¿¡æ¯æ²’å®Œæˆ
          /ç‡Ÿæ¥­[^ã€‚]*$/, // ç‡Ÿæ¥­æ™‚é–“æ²’å®Œæˆ
          /äº¤é€š[ï¼š:]?[^ã€‚]*æ­ä¹˜[^ã€‚]*$/, // äº¤é€šä¿¡æ¯æ²’å®Œæˆ
          /ä½å®¿[ï¼š:]?[^ã€‚]*é¸æ“‡[^ã€‚]*$/ // ä½å®¿ä¿¡æ¯æ²’å®Œæˆ
        ];
        
        if (semanticIncomplete.some(pattern => pattern.test(last100Chars))) {
          console.log('æª¢æ¸¬åˆ°èªç¾©ä¸å®Œæ•´');
          return true;
        }
      }
      
      console.log('å›æ‡‰çœ‹èµ·ä¾†æ˜¯å®Œæ•´çš„');
      return isTruncated;
    },    // è«‹æ±‚ç¹¼çºŒç”Ÿæˆå®Œæ•´å›æ‡‰
    async requestContinuation(partialResponse) {
      try {
        console.log('å˜—è©¦è«‹æ±‚ç¹¼çºŒç”Ÿæˆï¼Œå·²æœ‰å…§å®¹é•·åº¦:', partialResponse.length);
        
        // ç¢ºä¿æœ‰å…§å®¹è¦ç¹¼çºŒç”Ÿæˆ
        if (!partialResponse || partialResponse.trim().length < 10) {
          console.warn('æ²’æœ‰è¶³å¤ çš„åˆå§‹å…§å®¹å¯ç¹¼çºŒç”Ÿæˆ');
          return partialResponse;
        }
        
        // ä¿å­˜åŸå§‹è«‹æ±‚ä¿¡æ¯ï¼Œç”¨æ–¼APIé‡è©¦
        const requestData = {
          partialContent: partialResponse, // ä¿æŒé€™å€‹éµåå…¼å®¹å¾Œç«¯
          content: partialResponse,        // æ–°å¢é€™å€‹éµåä½œç‚ºå‚™ç”¨
          originalRequest: {               // ä¿æŒé€™å€‹çµæ§‹å…¼å®¹å¾Œç«¯
            region: this.selectedRegion,
            country: this.selectedCountry,
            days: this.travelDays,
            departureDate: this.departureDate,
            travelType: this.travelType,
            specialRequirements: this.specialRequirements
          },
          metadata: {                      // æ–°å¢é€™å€‹çµæ§‹ä½œç‚ºå‚™ç”¨
            region: this.selectedRegion,
            country: this.selectedCountry,
            days: this.travelDays,
            departureDate: this.departureDate,
            travelType: this.travelType
          }
        };
        
        if (this.specialRequirements) {
          requestData.metadata.specialRequirements = this.specialRequirements;
        }
        
        // ç™¼é€è«‹æ±‚åˆ°ç¹¼çºŒç”ŸæˆAPI
        const continueResponse = await axios.post(`${this.apiBaseUrl}/ai/continue`, requestData, {
          timeout: 90000  // å¢åŠ è¶…æ™‚æ™‚é–“åˆ°90ç§’
        });
        
        console.log('ç¹¼çºŒç”ŸæˆAPIéŸ¿æ‡‰:', continueResponse.status);
        
        if (continueResponse.data && continueResponse.data.success) {
          // åˆä½µå®Œæ•´å›æ‡‰ï¼Œè™•ç†æ–°éŸ¿æ‡‰æ ¼å¼
          if (continueResponse.data.data && continueResponse.data.data.content) {
            // æ–°æ ¼å¼
            return partialResponse + continueResponse.data.data.content;
          } else if (continueResponse.data.message) {
            // èˆŠæ ¼å¼
            return partialResponse + continueResponse.data.message;
          }
        }
      } catch (error) {
        console.error('ç„¡æ³•è«‹æ±‚ç¹¼çºŒç”Ÿæˆ:', error.response?.status || error.message);
        // é¡¯ç¤ºéŒ¯èª¤åˆ°UI
        this.showError(`ç„¡æ³•ç¹¼çºŒç”Ÿæˆå…§å®¹: ${error.response?.data?.error || error.message}`);
      }
      
      // å¦‚æœç„¡æ³•ç¹¼çºŒç”Ÿæˆï¼Œå˜—è©¦æ‰‹å‹•è£œå®Œ
      return this.manuallyComplete(partialResponse);
    },

    // æ›´æ™ºèƒ½çš„æ‰‹å‹•è£œå®Œæ–¹æ³•
    manuallyComplete(partialResponse) {
      console.log('å˜—è©¦æ™ºèƒ½è£œå®Œå›æ‡‰');
      
      let completed = partialResponse.trim();
      const lastPart = completed.slice(-100);
      
      // æ ¹æ“šä¸åŒçš„æˆªæ–·æƒ…æ³é€²è¡Œè£œå®Œ
      
      // 1. è™•ç†åƒ"å½ˆ"é€™æ¨£çš„å­—ç¬¦æˆªæ–·
      if (completed.match(/[é€™æ˜¯ä¸€å€‹å½ˆ]$/)) {
        completed = completed.slice(0, -1) + 'å½ˆæ€§çš„è¡Œç¨‹å®‰æ’ï¼Œæ‚¨å¯ä»¥æ ¹æ“šå€‹äººå–œå¥½å’Œå¯¦éš›æƒ…æ³é€²è¡Œèª¿æ•´ã€‚';
      }
      
      // 2. è™•ç†æ³¨æ„äº‹é …æˆªæ–­
      else if (lastPart.match(/æ³¨æ„äº‹é …\s*[ï¼š:]*\s*\*?\s*$/)) {
        completed += '\n';
        completed += '* è«‹æå‰ç¢ºèªå„æ™¯é»çš„é–‹æ”¾æ™‚é–“å’Œé–€ç¥¨åƒ¹æ ¼\n';
        completed += '* å»ºè­°è³¼è²·æ—…éŠä¿éšªä»¥ä¿éšœè¡Œç¨‹å®‰å…¨\n';
        completed += '* æº–å‚™é©åˆç•¶åœ°æ°£å€™çš„æœè£å’Œç”¨å“\n';
        completed += '* ä¿æŒè­·ç…§å’Œé‡è¦æ–‡ä»¶çš„å‚™ä»½\n';
        completed += '* å­¸ç¿’ä¸€äº›åŸºæœ¬çš„ç•¶åœ°èªè¨€å’Œç¦®å„€';
      }
      
      // 3. è™•ç†äº¤é€šä¿¡æ¯æˆªæ–·
      else if (lastPart.match(/æ­ä¹˜[^ã€‚]*$/)) {
        const transportMatch = lastPart.match(/æ­ä¹˜([^ã€‚]*?)$/);
        if (transportMatch) {
          const transport = transportMatch[1];
          if (transport.includes('JR') || transport.includes('åœ°éµ') || transport.includes('å·´å£«')) {
            completed += 'å‰å¾€ç›®çš„åœ°ï¼Œè»Šç¨‹ç´„30-60åˆ†é˜ï¼Œè«‹æ³¨æ„ç™¼è»Šæ™‚é–“ã€‚';
          } else {
            completed += 'å‰å¾€ä¸‹ä¸€å€‹ç›®çš„åœ°ï¼Œè«‹æå‰ç¢ºèªäº¤é€šæ™‚åˆ»è¡¨ã€‚';
          }
        }
      }
      
      // 4. è™•ç†å‹•ä½œè©æˆªæ–·
      else if (lastPart.match(/[å‰å¾€|åƒè§€|å¯ä»¥|å»ºè­°][^ã€‚]*$/)) {
        completed += 'ï¼Œè©³ç´°ä¿¡æ¯è«‹æ ¹æ“šç•¶åœ°å¯¦éš›æƒ…æ³é€²è¡Œç¢ºèªã€‚';
      }
      
      // 5. è™•ç†åˆ—è¡¨é …ç›®æˆªæ–·
      else if (lastPart.match(/\*\s*$/)) {
        completed += ' è«‹æ ¹æ“šå€‹äººå–œå¥½é¸æ“‡åˆé©çš„æ´»å‹•';
      }
      
      // 6. è™•ç†å†’è™Ÿå¾Œæˆªæ–·
      else if (lastPart.match(/[ï¼š:]\s*$/)) {
        completed += ' è©³ç´°å®‰æ’è«‹åƒè€ƒä»¥ä¸Šå»ºè­°ã€‚';
      }
      
      // 7. é€šç”¨çµå°¾è™•ç†
      if (!completed.trim().match(/[ã€‚ï¼ï¼Ÿ.!?âœˆï¸ğŸ‰]$/)) {
        completed += 'ã€‚';
      }
      
      // æ·»åŠ å‹å¥½çš„çµå°¾
      if (!completed.includes('ç¥æ‚¨æ—…é€”æ„‰å¿«') && !completed.includes('Have a nice trip')) {
        completed += '\n\nç¥æ‚¨æ—…é€”æ„‰å¿«ï¼ ğŸ‰âœˆï¸';
      }
      
      return completed;
    },
    
    // é¡å¤–çš„å›æ‡‰è³ªé‡æª¢æŸ¥
    validateResponseQuality(response) {
      const issues = [];
      
      // æª¢æŸ¥æœ€çŸ­é•·åº¦
      if (response.length < 500) {
        issues.push('å›æ‡‰å…§å®¹éçŸ­');
      }
      
      // æª¢æŸ¥æ˜¯å¦åŒ…å«åŸºæœ¬æ—…éŠä¿¡æ¯
      const essentialKeywords = ['å¤©', 'è¡Œç¨‹', 'æ™¯é»', 'äº¤é€š', 'ä½å®¿'];
      const missingKeywords = essentialKeywords.filter(keyword => 
        !response.includes(keyword)
      );
      
      if (missingKeywords.length > 2) {
        issues.push(`ç¼ºå°‘é‡è¦é—œéµå­—: ${missingKeywords.join(', ')}`);
      }
      
      // æª¢æŸ¥Markdownæ ¼å¼
      const unclosedMarkdown = [
        { pattern: /\*\*[^*]*$/, name: 'æœªé–‰åˆçš„ç²—é«”' },
        { pattern: /#{1,6}[^#\n]*$/, name: 'æœªé–‰åˆçš„æ¨™é¡Œ' },
        { pattern: /\[[^\]]*$/, name: 'æœªé–‰åˆçš„é€£çµ' }
      ];
      
      unclosedMarkdown.forEach(({ pattern, name }) => {
        if (pattern.test(response)) {
          issues.push(name);
        }
      });
      
      return {
        isValid: issues.length === 0,
        issues: issues
      };
    },
    
    // å¢å¼·éçŸ­çš„å›æ‡‰
    enhanceShortResponse(shortResponse) {
      console.log('å¢å¼·éçŸ­çš„å›æ‡‰');
      let enhanced = shortResponse;
      
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰è¡Œç¨‹çµæ§‹
      const hasDays = shortResponse.includes('ç¬¬1å¤©') || shortResponse.includes('ç¬¬ä¸€å¤©');
      const hasIntro = shortResponse.includes('è¡Œç¨‹æ¦‚è¿°') || shortResponse.includes('è¡Œç¨‹æº–å‚™');
      const hasSummary = shortResponse.includes('è¡Œç¨‹ç¸½çµ') || shortResponse.includes('ç¸½çµ');
      
      // å¦‚æœæ²’æœ‰è¡Œç¨‹çµæ§‹ï¼Œæ·»åŠ åŸºæœ¬çµæ§‹
      if (!hasDays && !hasIntro) {
        enhanced = `# ${this.selectedCountry}${this.travelDays}å¤©æ—…éŠè¡Œç¨‹\n\n` + enhanced;
      }
      
      // æ·»åŠ è¡Œç¨‹æº–å‚™éƒ¨åˆ†ï¼ˆå¦‚æœç¼ºå°‘ï¼‰
      if (!hasIntro) {
        enhanced += `\n\n## è¡Œç¨‹æº–å‚™\n\n`;
        enhanced += `**ç›®çš„åœ°ï¼š** ${this.selectedCountry}\n`;
        enhanced += `**æ—…éŠå¤©æ•¸ï¼š** ${this.travelDays}\n`;
        enhanced += `**æ—…éŠé¡å‹ï¼š** ${this.travelType || 'ä¸€èˆ¬è§€å…‰'}\n`;
        if (this.departureDate) {
          enhanced += `**å‡ºç™¼æ—¥æœŸï¼š** ${this.departureDate}\n`;
        }
        if (this.specialRequirements) {
          enhanced += `**ç‰¹åˆ¥éœ€æ±‚ï¼š** ${this.specialRequirements}\n`;
        }
      }
      
      // æ·»åŠ è¡Œç¨‹ç¸½çµï¼ˆå¦‚æœç¼ºå°‘ï¼‰
      if (!hasSummary) {
        enhanced += `\n\n## è¡Œç¨‹ç¸½çµ\n\n`;
        enhanced += `é€™å€‹${this.travelDays}å¤©çš„${this.selectedCountry}ä¹‹æ—…å°‡å¸¶çµ¦æ‚¨è±å¯Œçš„é«”é©—å’Œç¾å¥½å›æ†¶ã€‚`;
        enhanced += `æ—…é€”ä¸­è«‹ä¿æŒå½ˆæ€§ï¼Œæ ¹æ“šç•¶åœ°æƒ…æ³é©æ™‚èª¿æ•´è¡Œç¨‹ã€‚\n\n`;
        enhanced += `**ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼** ğŸ‰âœˆï¸`;
      }
      
      return enhanced;
    },
    
    // ä¿®å¾©æœªé–‰åˆçš„Markdownæ¨™è¨˜
    fixUnclosedMarkdown(response) {
      console.log('ä¿®å¾©æœªé–‰åˆçš„Markdownæ¨™è¨˜');
      let fixed = response;
      
      // ä¿®å¾©æœªé–‰åˆçš„ç²—é«”æ¨™è¨˜
      const boldMatch = fixed.match(/\*\*([^*]*)$/);
      if (boldMatch) {
        fixed = fixed.replace(/\*\*([^*]*)$/, `**${boldMatch[1]}**`);
      }
      
      // ä¿®å¾©æœªé–‰åˆçš„æ–œé«”æ¨™è¨˜
      const italicMatch = fixed.match(/(?<!\*)\*([^*\n]*)$/);
      if (italicMatch) {
        fixed = fixed.replace(/(?<!\*)\*([^*\n]*)$/, `*${italicMatch[1]}*`);
      }
      
      // ä¿®å¾©æœªé–‰åˆçš„é€£çµ
      const linkTextMatch = fixed.match(/\[([^\]]*?)$/);
      if (linkTextMatch) {
        fixed = fixed.replace(/\[([^\]]*?)$/, `[${linkTextMatch[1]}](é€£çµ)`);
      }
      
      // ä¿®å¾©æœªé–‰åˆçš„ä»£ç¢¼å¡Š
      if (fixed.match(/```[^`]*$/)) {
        fixed += '\n```';
      }
      
      return fixed;
    },

    // è™•ç†APIéŒ¯èª¤
    handleApiError(apiError) {
      if (apiError.code === 'ECONNABORTED') {
        this.errorMessage = 'APIè«‹æ±‚è¶…æ™‚ï¼Œæ­£åœ¨ä½¿ç”¨å‚™é¸æ–¹æ¡ˆç”Ÿæˆè¡Œç¨‹...';
      } else if (apiError.response?.status === 413) {
        this.errorMessage = 'è«‹æ±‚å…§å®¹éå¤§ï¼Œæ­£åœ¨ç°¡åŒ–è«‹æ±‚ä¸¦é‡è©¦...';
      } else if (apiError.response?.status === 429) {
        this.errorMessage = 'APIè«‹æ±‚é »ç‡éé«˜ï¼Œè«‹ç¨å¾Œå†è©¦...';
      } else {
        console.warn('APIé€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™:', apiError.message);
      }
    },

    // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
    showError(errorMsg) {
      this.errorMessage = errorMsg;
      console.warn(errorMsg);
      // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯3ç§’å¾Œè‡ªå‹•æ¸…é™¤
      setTimeout(() => {
        if (this.errorMessage === errorMsg) {
          this.errorMessage = null;
        }
      }, 3000);
    },    // æ›´æ–°å¤©æ•¸è¨ˆç®—å’Œè­¦å‘Šç‹€æ…‹    updateDaysCountAndWarning() {
      if (!this.aiResponse) {
        this.actualDaysCount = 0;
        this.showDaysWarning = false;
        return;
      }
      
      // ä½¿ç”¨å®Œæ•´çš„æ­£å‰‡è¡¨é”å¼åŒ¹é…å„ç¨®å¯èƒ½çš„æ—¥æœŸæ¨™é¡Œæ ¼å¼
      // 1. H1æ¨™é¡Œ: # ç¬¬Xå¤©
      const h1DayHeaders = this.aiResponse.match(/# ç¬¬\d+å¤©/g) || [];
      
      // 2. H2æ¨™é¡Œ: ## ç¬¬Xå¤©
      const h2DayHeaders = this.aiResponse.match(/## ç¬¬\d+å¤©/g) || [];
      
      // 3. ç´”æ–‡æœ¬: ç¬¬Xå¤© (å¾Œé¢ä¸æ˜¯#è™Ÿ)
      const plainDayHeaders = this.aiResponse.match(/ç¬¬\d+å¤©[^#]/g) || [];
      
      // 4. è‹±æ–‡Dayæ ¼å¼: Day X
      const englishDayHeaders = this.aiResponse.match(/Day\s+\d+/gi) || [];
      
      // 5. æ•¸å­—å¤©æ ¼å¼: 1å¤©/2å¤©ç­‰
      const numDayHeaders = this.aiResponse.match(/^\d+å¤©/gm) || [];
      
      // å¾å„ç¨®æ¨™é¡Œæ ¼å¼ä¸­æå–æ‰€æœ‰æ•¸å­—
      const allDayNumbers = [];
      
      // è™•ç†H1æ¨™é¡Œä¸­çš„æ•¸å­—
      h1DayHeaders.forEach(header => {
        const match = header.match(/\d+/);
        if (match) allDayNumbers.push(parseInt(match[0]));
      });
      
      // è™•ç†H2æ¨™é¡Œä¸­çš„æ•¸å­—
      h2DayHeaders.forEach(header => {
        const match = header.match(/\d+/);
        if (match) allDayNumbers.push(parseInt(match[0]));
      });
      
      // è™•ç†ç´”æ–‡æœ¬æ ¼å¼ä¸­çš„æ•¸å­—
      plainDayHeaders.forEach(header => {
        const match = header.match(/\d+/);
        if (match) allDayNumbers.push(parseInt(match[0]));
      });
      
      // è™•ç†è‹±æ–‡Dayæ ¼å¼ä¸­çš„æ•¸å­—
      englishDayHeaders.forEach(header => {
        const match = header.match(/\d+/);
        if (match) allDayNumbers.push(parseInt(match[0]));
      });
      
      // è™•ç†æ•¸å­—å¤©æ ¼å¼
      numDayHeaders.forEach(header => {
        const match = header.match(/\d+/);
        if (match) allDayNumbers.push(parseInt(match[0]));
      });
      
      // ç¸½å¤©æ•¸è¨ˆç®— - æ¨™é¡Œæ•¸é‡æˆ–å¤©æ•¸ç·¨è™Ÿçš„æœ€å¤§å€¼
      const headerCount = h1DayHeaders.length + h2DayHeaders.length + 
                         plainDayHeaders.length + englishDayHeaders.length + 
                         numDayHeaders.length;
      
      const maxDayNumber = allDayNumbers.length > 0 ? Math.max(...allDayNumbers) : 0;
      
      // åˆæ­¥ç¢ºå®šå¯¦éš›å¤©æ•¸
      this.actualDaysCount = Math.max(headerCount, maxDayNumber);
      
      console.log(`åµæ¸¬åˆ°æ¨™é¡Œæ•¸é‡=${headerCount}, æœ€å¤§å¤©æ•¸ç·¨è™Ÿ=${maxDayNumber}`);
      console.log(`åµæ¸¬åˆ°${this.actualDaysCount}å¤©çš„è¡Œç¨‹æ¨™é¡Œ:`, 
                 `H1:${h1DayHeaders.length}, H2:${h2DayHeaders.length}, ç´”æ–‡æœ¬:${plainDayHeaders.length}, `,
                 `è‹±æ–‡:${englishDayHeaders.length}, æ•¸å­—å¤©:${numDayHeaders.length}`);
      console.log('å¤©æ•¸æ•¸å­—åˆ—è¡¨:', allDayNumbers);
      
      // å¦‚æœå·²ç¶“å¾å…¶ä»–åœ°æ–¹æª¢æ¸¬åˆ°ç¢ºåˆ‡å¤©æ•¸ï¼Œæ¯”è¼ƒä¸¦ä½¿ç”¨è¼ƒå¤§çš„å€¼
      if (this.detectedDaysCount > 0) {
        const previousCount = this.actualDaysCount;
        this.actualDaysCount = Math.max(this.actualDaysCount, this.detectedDaysCount);
        console.log(`ä½¿ç”¨æª¢æ¸¬åˆ°çš„å¤©æ•¸: ${previousCount} -> ${this.actualDaysCount} (detectedDaysCount=${this.detectedDaysCount})`);
      }
      
      // å¦‚æœæ˜¯ç¯„åœå¤©æ•¸ (ä¾‹å¦‚3-5å¤©)ï¼Œä½¿ç”¨ç¯„åœçš„æœ€å¤§å€¼ä½œç‚ºæœŸæœ›å€¼
      const expectedDays = this.requestedMaxDays > this.requestedMinDays ? 
                           this.requestedMaxDays : this.requestedMinDays;
      
      // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºå¤©æ•¸ä¸è¶³è­¦å‘Š - åªåœ¨å¯¦éš›å¤©æ•¸å°æ–¼ç”¨æˆ¶è«‹æ±‚çš„æœ€å°å¤©æ•¸æ™‚é¡¯ç¤º
      if (this.actualDaysCount === 0 || this.requestedMinDays === 0) {
        this.showDaysWarning = false;
      } else {
        // å¦‚æœå¤©æ•¸æ˜¯ç¯„åœï¼Œä¾‹å¦‚3-5å¤©ï¼Œåªæœ‰ç•¶å¯¦éš›å¤©æ•¸å°æ–¼æœ€å°å€¼æ‰é¡¯ç¤ºè­¦å‘Š
        this.showDaysWarning = this.actualDaysCount < this.requestedMinDays;
      }
      
      console.log(`æ›´æ–°å¤©æ•¸è¨ˆç®—çµæœ: å¯¦éš›å¤©æ•¸=${this.actualDaysCount}, è«‹æ±‚æœ€å°å¤©æ•¸=${this.requestedMinDays}, è«‹æ±‚ç¯„åœ=${this.requestedMinDays}-${this.requestedMaxDays}, é¡¯ç¤ºè­¦å‘Š=${this.showDaysWarning}`);
    },
    
    // ç”Ÿæˆå®Œæ•´çš„æ¨¡æ“¬å›æ‡‰
    generateCompleteMockResponse() {
      const daysNum = parseInt(this.travelDays.split('-')[0]) || 3;
      
      let mockResponse = `# ${this.selectedCountry}${this.travelDays}å¤©æ·±åº¦ä¹‹æ—…\n\n`;
      mockResponse += `**è¡Œç¨‹æ¦‚è¿°ï¼š** é€™æ˜¯ä¸€å€‹å°ˆç‚º${this.travelType || 'ä¸€èˆ¬éŠå®¢'}è¨­è¨ˆçš„${this.selectedCountry}æ—…éŠè¡Œç¨‹ï¼Œæ¶µè“‹äº†ä¸»è¦æ™¯é»ã€æ–‡åŒ–é«”é©—å’Œç¾é£Ÿäº«å—ã€‚\n\n`;
      
      // è¡Œç¨‹å‰æº–å‚™
      mockResponse += `## è¡Œç¨‹æº–å‚™\n\n`;
      mockResponse += `**å‡ºç™¼æ—¥æœŸï¼š** ${this.departureDate || 'è«‹ç¢ºèªæ‚¨çš„å‡ºç™¼æ—¥æœŸ'}\n`;
      mockResponse += `**æ—…éŠå¤©æ•¸ï¼š** ${this.travelDays}å¤©\n`;
      mockResponse += `**æ—…éŠé¡å‹ï¼š** ${this.travelType || 'ç¶œåˆæ—…éŠ'}\n\n`;
      
      if (this.specialRequirements) {
        mockResponse += `**ç‰¹åˆ¥éœ€æ±‚ï¼š** ${this.specialRequirements}\n\n`;
      }      // è©³ç´°è¡Œç¨‹ - ç¢ºä¿ç”Ÿæˆçš„å¤©æ•¸èˆ‡ç”¨æˆ¶è«‹æ±‚çš„ä¸€è‡´ï¼Œä¸å¤šä¸å°‘
      const requestedDays = this.travelDays.includes('-') ? 
        parseInt(this.travelDays.split('-')[0]) : parseInt(this.travelDays);
        // ç¸½æ˜¯ä½¿ç”¨ç”¨æˆ·è«‹æ±‚çš„å¤©æ•¸ï¼Œç¢ºä¿ç”Ÿæˆæ­£ç¢ºçš„å¤©æ•¸
      const daysToGenerate = requestedDays || daysNum;
      
      console.log(`æ­£åœ¨ç”Ÿæˆ${daysToGenerate}å¤©çš„è¡Œç¨‹... (åµæ¸¬åˆ°${this.detectedDaysCount}å¤©, è«‹æ±‚${requestedDays}å¤©)`);
      
      // ç¢ºä¿ç”Ÿæˆç”¨æˆ¶è«‹æ±‚çš„ç¢ºåˆ‡å¤©æ•¸ï¼Œä¸å¤šä¸å°‘
      for (let day = 1; day <= daysToGenerate; day++) {
        mockResponse += this.getDetailedDayContent(day);
      }
      
      // å¯¦ç”¨ä¿¡æ¯
      mockResponse += `## å¯¦ç”¨ä¿¡æ¯\n\n`;
      mockResponse += `**äº¤é€šï¼š** å»ºè­°æå‰é è¨‚æ©Ÿç¥¨å’Œç•¶åœ°äº¤é€šç¥¨åˆ¸\n`;
      mockResponse += `**ä½å®¿ï¼š** æ¨è–¦é¸æ“‡äº¤é€šä¾¿åˆ©çš„å¸‚ä¸­å¿ƒå€åŸŸ\n`;
      mockResponse += `**é ç®—ï¼š** æ ¹æ“šæ‚¨çš„æ¶ˆè²»ç¿’æ…£å’Œæ—…éŠå¤©æ•¸åˆ¶å®šåˆç†é ç®—\n`;
      mockResponse += `**å¿…å‚™ç‰©å“ï¼š** è­·ç…§ã€ç°½è­‰ã€æ—…éŠä¿éšªã€é©åˆçš„æœè£\n\n`;
      
      mockResponse += `## è¡Œç¨‹ç¸½çµ\n\n`;
      mockResponse += `é€™å€‹${this.travelDays}å¤©çš„${this.selectedCountry}ä¹‹æ—…å°‡å¸¶çµ¦æ‚¨è±å¯Œçš„æ–‡åŒ–é«”é©—å’Œç¾å¥½å›æ†¶ã€‚è¨˜å¾—ä¿æŒé–‹æ”¾çš„å¿ƒæ…‹ï¼Œäº«å—æ¯ä¸€å€‹ç²¾å½©æ™‚åˆ»ï¼\n\n`;      mockResponse += `**ç¥æ‚¨æ—…é€”æ„‰å¿«ï¼** ğŸ‰âœˆï¸`;
      
      this.aiResponse = mockResponse;
      this.updateDaysCountAndWarning();
    },

    getDetailedDayContent(day) {
      const destinations = {
        1: { title: `æŠµé”${this.selectedCountry}`, activities: ['æ©Ÿå ´æ¥é€', 'é…’åº—å…¥ä½', 'å¸‚å€åˆæ¢', 'æ­¡è¿æ™šé¤'] },
        2: { title: 'å¸‚ä¸­å¿ƒè§€å…‰', activities: ['è‘—åæ™¯é»åƒè§€', 'æ–‡åŒ–é«”é©—æ´»å‹•', 'ç•¶åœ°ç¾é£Ÿå“åš', 'è³¼ç‰©é«”é©—'] },
        3: { title: 'æ·±åº¦æ–‡åŒ–é«”é©—', activities: ['æ­·å²å¤è¹Ÿåƒè§€', 'å‚³çµ±æ‰‹å·¥è—é«”é©—', 'ç•¶åœ°äººäº¤æµ', 'ç‰¹è‰²è¡¨æ¼”è§€è³'] },
        4: { title: 'è‡ªç„¶é¢¨å…‰æ¢ç´¢', activities: ['è‡ªç„¶æ™¯å€éŠè¦½', 'æˆ¶å¤–æ´»å‹•é«”é©—', 'é¢¨æ™¯æ”å½±', 'ç”Ÿæ…‹è§€å¯Ÿ'] },
        5: { title: 'ç¾é£Ÿèˆ‡è³¼ç‰©', activities: ['å¸‚å ´æ¢ç´¢', 'çƒ¹é£ªèª²ç¨‹', 'è³¼ç‰©å¤©å ‚', 'ç´€å¿µå“é¸è³¼'] },
        6: { title: 'å‘¨é‚Šåœ°å€ä¸€æ—¥éŠ', activities: ['éƒŠå€æ™¯é»', 'é„‰æ‘é«”é©—', 'ç•¶åœ°ç¯€æ…¶', 'ç‰¹è‰²æ´»å‹•'] },
        7: { title: 'å‘Šåˆ¥èˆ‡è¿”ç¨‹', activities: ['æœ€å¾Œè³¼ç‰©', 'è¡Œææ•´ç†', 'æ©Ÿå ´é€æ©Ÿ', 'å›ç¨‹æº–å‚™'] }
      };
      
      const dayInfo = destinations[day] || destinations[1];
      
      let content = `## ç¬¬${day}å¤©ï¼š${dayInfo.title}\n\n`;
      
      const timeSlots = ['ä¸Šåˆ', 'ä¸‹åˆ', 'æ™šä¸Š'];
      const activitiesPerSlot = Math.ceil(dayInfo.activities.length / timeSlots.length);
      
      timeSlots.forEach((time, index) => {
        content += `**${time}ï¼š**\n`;
        const startIdx = index * activitiesPerSlot;
        const endIdx = Math.min(startIdx + activitiesPerSlot, dayInfo.activities.length);
        
        for (let i = startIdx; i < endIdx; i++) {
          if (dayInfo.activities[i]) {
            content += `* ${dayInfo.activities[i]}\n`;
          }
        }
        content += '\n';
      });
      
      content += `**ä½å®¿å»ºè­°ï¼š** é¸æ“‡é è¿‘ä¸»è¦æ™¯é»çš„èˆ’é©é…’åº—\n`;
      content += `**é¤é£²æ¨è–¦ï¼š** å“åšç•¶åœ°ç‰¹è‰²æ–™ç†å’Œåœ‹éš›ç¾é£Ÿ\n\n`;
      
      return content;
    },    modifyItinerary() {
      // æª¢æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆæ›´å¤šå¤©æ•¸
      if (this.showDaysWarning) {
        // å¦‚æœå¤©æ•¸ä¸è¶³ï¼Œæä¾›æ›´æ˜ç¢ºçš„ç¹¼çºŒç”Ÿæˆæç¤º
        const missingDays = this.requestedMinDays - this.actualDaysCount;
        const nextDay = this.actualDaysCount + 1;
        
        this.specialRequirements = `åŸºæ–¼ä¸Šè¿°è¡Œç¨‹ï¼Œè«‹ç¹¼çºŒç”Ÿæˆç¬¬${nextDay}å¤©è‡³ç¬¬${this.requestedMinDays}å¤©çš„å®Œæ•´è¡Œç¨‹ï¼š

ç‰¹åˆ¥èªªæ˜ï¼š
1. éœ€è¦ç”Ÿæˆ${missingDays}å¤©çš„é¡å¤–è¡Œç¨‹ï¼ˆå¾ç¬¬${nextDay}å¤©åˆ°ç¬¬${this.requestedMinDays}å¤©ï¼‰
2. è«‹å’Œå‰é¢${this.actualDaysCount}å¤©ä¿æŒç›¸åŒçš„æ ¼å¼å’Œé¢¨æ ¼
3. å¯ä»¥å»ºè­°åƒè§€ä»¥ä¸‹æ™¯é»æˆ–åœ°é»ï¼š[ç”¨æˆ¶å¯åœ¨æ­¤å¡«å…¥]
`;
      } else {
        // è‹¥å¤©æ•¸è¶³å¤ ï¼Œå‰‡æ˜¯ä¸€èˆ¬ä¿®æ”¹
        this.specialRequirements = 'åŸºæ–¼ç›®å‰è¡Œç¨‹ï¼Œæˆ‘å¸Œæœ›ä¿®æ”¹ï¼š\n\n';
      }
      
      // æ»¾å‹•åˆ°è¡¨å–®å€åŸŸ
      window.scrollTo({
        top: document.querySelector('form').offsetTop - 100,
        behavior: 'smooth'
      });
    },saveItinerary() {
      if (!this.aiResponse) return;
      
      const newItinerary = {
        id: Date.now(),
        date: new Date().toLocaleDateString(),
        region: this.selectedRegion,
        country: this.selectedCountry,
        days: this.travelDays,
        type: this.travelType,
        departureDate: this.departureDate || '',
        specialRequirements: this.specialRequirements || '',
        content: this.aiResponse
      };
      
      // å¾æœ¬åœ°å„²å­˜ç²å–å·²æœ‰è¡Œç¨‹
      let savedItineraries = JSON.parse(localStorage.getItem('savedItineraries') || '[]');
      
      // æ·»åŠ æ–°è¡Œç¨‹
      savedItineraries.push(newItinerary);
      
      // ä¿å­˜å›æœ¬åœ°å„²å­˜
      localStorage.setItem('savedItineraries', JSON.stringify(savedItineraries));
      
      // æ›´æ–°çµ„ä»¶ä¸­çš„è³‡æ–™
      this.savedItineraries = savedItineraries;
      
      alert('è¡Œç¨‹å·²å„²å­˜åˆ°æ‚¨çš„ç€è¦½å™¨ä¸­ï¼æ‚¨å¯ä»¥é»æ“Š"æŸ¥çœ‹å„²å­˜çš„è¡Œç¨‹"æŒ‰éˆ•ä¾†æŸ¥çœ‹ã€‚\n\næ³¨æ„ï¼šå¦‚æœè¦åœ¨ç…§ç‰‡ç‰†ä¸­é—œè¯è¡Œç¨‹ï¼Œè«‹ä½¿ç”¨"ç¢ºèªæ¡ç”¨æ­¤è¡Œç¨‹"æŒ‰éˆ•å°‡è¡Œç¨‹å„²å­˜è‡³é›²ç«¯ã€‚');
    },    
    async confirmAndSaveToFirebase() {
      if (!this.aiResponse) {
        alert('æ²’æœ‰è¡Œç¨‹å…§å®¹å¯ä»¥å„²å­˜');
        return;
      }
      
      if (!isAuthenticated.value) {
        this.showLoginPrompt = true;
        setTimeout(() => {
          this.router.push('/login?redirect=/advice');
        }, 5000);
        return;
      }
      
      try {
        this.isProcessing = true;
        
        // å¾è¡Œç¨‹å…§å®¹ä¸­æå–è³‡è¨Š (é¡ä¼¼çˆ¬èŸ²)
        const extractedInfo = this.extractInfoFromItinerary(this.aiResponse);
        
        // å¦‚æœç„¡æ³•å¾å…§å®¹ä¸­æå–åˆ°åœ‹å®¶å’Œå¤©æ•¸ï¼Œå‰‡ä½¿ç”¨è¡¨å–®ä¸­çš„å€¼
        let country = this.selectedCountry || extractedInfo.country;
        let days = this.travelDays || extractedInfo.days;
        let region = this.selectedRegion || extractedInfo.region || 'æœªæŒ‡å®šå€åŸŸ';
        let type = this.travelType || extractedInfo.type || 'ä¸€èˆ¬æ—…éŠ';
        
        // å¦‚æœä»ç„¶æ²’æœ‰åœ‹å®¶è³‡è¨Šï¼Œå˜—è©¦å¾è¡Œç¨‹æ¨™é¡Œä¸­æå–
        if (!country) {
          // å˜—è©¦å°‹æ‰¾å¸¸è¦‹åœ‹å®¶åç¨±
          const content = this.aiResponse;
          const commonCountries = [
            'æ—¥æœ¬', 'éŸ“åœ‹', 'æ³°åœ‹', 'å°ç£', 'æ–°åŠ å¡', 'é¦¬ä¾†è¥¿äº', 'è¶Šå—', 
            'å°å°¼', 'è²å¾‹è³“', 'ä¸­åœ‹', 'é¦™æ¸¯', 'æ¾³é–€', 'å°åº¦', 'ç¾åœ‹', 'åŠ æ‹¿å¤§', 
            'å¢¨è¥¿å“¥', 'è‹±åœ‹', 'æ³•åœ‹', 'å¾·åœ‹', 'ç¾©å¤§åˆ©', 'è¥¿ç­ç‰™', 'è‘¡è„ç‰™', 
            'ç‘å£«', 'è·è˜­', 'æ¯”åˆ©æ™‚', 'å¥§åœ°åˆ©', 'å¸Œè‡˜', 'æ¾³æ´²', 'ç´è¥¿è˜­'
          ];
          
          for (const possibleCountry of commonCountries) {
            if (content.includes(possibleCountry + 'è¡Œç¨‹') || 
                content.includes(possibleCountry + 'æ—…éŠ') || 
                content.includes(possibleCountry + 'æ—…è¡Œ') ||
                content.includes(possibleCountry + ' ') ||
                content.includes('å‰å¾€' + possibleCountry) ||
                content.match(new RegExp(`${possibleCountry}\\d+å¤©`))) {
              country = possibleCountry;
              break;
            }
          }
        }

        // å¦‚æœä»ç„¶æ²’æœ‰å¤©æ•¸è³‡è¨Šï¼Œå˜—è©¦å¾è¡Œç¨‹ä¸­æŸ¥æ‰¾å¸¸è¦‹çš„å¤©æ•¸æ¨¡å¼
        if (!days) {
          const content = this.aiResponse;
          const daysMatch = content.match(/(\d+[-+]?\d*)å¤©/);
          if (daysMatch) {
            days = daysMatch[1];
          } else if (content.includes('3-5å¤©') || content.includes('3åˆ°5å¤©')) {
            days = '3-5';
          } else if (content.includes('6-8å¤©') || content.includes('6åˆ°8å¤©')) {
            days = '6-8';
          } else if (content.includes('9-12å¤©') || content.includes('9åˆ°12å¤©')) {
            days = '9-12';
          } else if (content.includes('13å¤©') || content.includes('å…©é€±')) {
            days = '13+';
          }
        }
        
        // å˜—è©¦å¾è¡Œç¨‹å…§å®¹æ¨æ–·å€åŸŸ
        if (!region || region === 'æœªæŒ‡å®šå€åŸŸ') {
          const content = this.aiResponse;
          const regionPatterns = {
            'asia': /äºæ´²|æ±äº|æ±å—äº|å—äº/i,
            'europe': /æ­æ´²|è¥¿æ­|æ±æ­|å—æ­|åŒ—æ­/i,
            'america': /ç¾æ´²|åŒ—ç¾|å—ç¾|æ‹‰ä¸ç¾æ´²/i,
            'oceania': /å¤§æ´‹æ´²|æ¾³æ´²/i,
            'africa': /éæ´²/i
          };
          
          for (const [regionKey, pattern] of Object.entries(regionPatterns)) {
            if (pattern.test(content)) {
              region = regionKey;
              break;
            }
          }
          
          // å¦‚æœä»ç„¶æ²’æœ‰å€åŸŸï¼Œæ ¹æ“šåœ‹å®¶æ¨æ¸¬å€åŸŸ
          if ((!region || region === 'æœªæŒ‡å®šå€åŸŸ') && country) {
            const countryToRegion = {
              'æ—¥æœ¬': 'asia', 'éŸ“åœ‹': 'asia', 'æ³°åœ‹': 'asia', 'å°ç£': 'asia', 'æ–°åŠ å¡': 'asia', 
              'é¦¬ä¾†è¥¿äº': 'asia', 'è¶Šå—': 'asia', 'å°å°¼': 'asia', 'è²å¾‹è³“': 'asia', 'å°åº¦': 'asia',
              'ä¸­åœ‹': 'asia', 'é¦™æ¸¯': 'asia', 'æ¾³é–€': 'asia',
              'è‹±åœ‹': 'europe', 'æ³•åœ‹': 'europe', 'å¾·åœ‹': 'europe', 'ç¾©å¤§åˆ©': 'europe', 
              'è¥¿ç­ç‰™': 'europe', 'è‘¡è„ç‰™': 'europe', 'ç‘å£«': 'europe',
              'ç¾åœ‹': 'america', 'åŠ æ‹¿å¤§': 'america', 'å¢¨è¥¿å“¥': 'america',
              'æ¾³æ´²': 'oceania', 'ç´è¥¿è˜­': 'oceania',
              'åŸƒåŠ': 'africa', 'æ‘©æ´›å“¥': 'africa', 'å—é': 'africa'
            };
            
            if (countryToRegion[country]) {
              region = countryToRegion[country];
            }
          }
        }
        
        // ç¢ºèªæ˜¯å¦æœ‰è¶³å¤ è³‡è¨Šå„²å­˜è¡Œç¨‹
        if (!country) {
          alert('ç„¡æ³•å„²å­˜ï¼šç³»çµ±ç„¡æ³•ç¢ºå®šç›®çš„åœ°åœ‹å®¶ï¼Œè«‹åœ¨è¡¨å–®ä¸­é¸æ“‡åœ‹å®¶');
          this.isProcessing = false;
          return;
        }
        
        if (!days) {
          alert('ç„¡æ³•å„²å­˜ï¼šç³»çµ±ç„¡æ³•ç¢ºå®šæ—…éŠå¤©æ•¸ï¼Œè«‹åœ¨è¡¨å–®ä¸­é¸æ“‡å¤©æ•¸');
          this.isProcessing = false;
          return;
        }
        
        // è‡ªå‹•æå–å¤©æ•¸æ•¸å­—ï¼ˆå¦‚æœæ˜¯ç¯„åœï¼Œå–ç¬¬ä¸€å€‹æ•¸å­—ï¼‰
        let daysNumber = days;
        if (typeof days === 'string') {
          if (days.includes('-')) {
            daysNumber = days.split('-')[0];
          } else if (days.includes('+')) {
            daysNumber = days.replace('+', '');
          }
        }
          // æå–æ¯æ—¥æ™¯é»äº®é»
        const dailyHighlights = this.extractDailyHighlights(this.aiResponse);
        
        // æº–å‚™è¡Œç¨‹è³‡æ–™ï¼ˆç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½æœ‰å€¼ï¼‰
        const itineraryData = {
          title: `${country} ${daysNumber}å¤©è¡Œç¨‹`,
          region: region,
          country: country,
          days: days,
          type: type,
          departureDate: this.departureDate || '',
          content: this.aiResponse,
          createdAt: new Date().toISOString(),
          specialRequirements: this.specialRequirements || '',
          dailyHighlights: dailyHighlights // æ·»åŠ æ¯æ—¥è¡Œç¨‹äº®é»
        };
          console.log('æ­£åœ¨å„²å­˜è¡Œç¨‹è‡³Firebase:', {
          title: itineraryData.title,
          country: itineraryData.country,
          days: itineraryData.days,
          region: itineraryData.region,
          dailyHighlights: itineraryData.dailyHighlights
        });
        
        // åƒ…å„²å­˜åˆ° Firebaseï¼Œä¸å†é‡è¤‡å„²å­˜åˆ° localStorage
        const result = await aiService.saveItineraryToFirebase(itineraryData);
        
        if (result.success) {
          alert(`è¡Œç¨‹å·²æˆåŠŸæ¡ç”¨ä¸¦å„²å­˜è‡³é›²ç«¯ï¼\nè¡Œç¨‹ID: ${result.id}\næ‚¨ç¾åœ¨å¯ä»¥åœ¨ç…§ç‰‡ç‰†ä¸­ä¸Šå‚³ä¸¦é—œè¯æ­¤è¡Œç¨‹çš„ç…§ç‰‡ã€‚`);
        } else {
          alert('å„²å­˜å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('å„²å­˜è¡Œç¨‹è‡³ Firebase å¤±æ•—:', error);
        alert('å„²å­˜è‡³é›²ç«¯å¤±æ•—ï¼š' + (error.message || 'ä¼ºæœå™¨éŒ¯èª¤'));
      } finally {
        this.isProcessing = false;
      }
    },
    
    // å¾è¡Œç¨‹å…§å®¹æå–å¿…è¦è³‡è¨Šï¼ˆåœ‹å®¶ã€å¤©æ•¸ç­‰ï¼‰
    extractInfoFromItinerary(content) {
      if (!content) return {};
      
      const result = {
        country: null,
        days: null,
        region: null,
        type: null
      };
      
      try {
        // å˜—è©¦æå–åœ‹å®¶åç¨±ï¼ˆå¤šç¨®æ¨¡å¼ï¼‰
        // æ¨¡å¼1: æ¨™é¡ŒåŒ¹é… - "# æ—¥æœ¬7å¤©è¡Œç¨‹"
        let titleMatch = content.match(/(?:^|\n)#\s*([^#\n]+?)(?:\d+|\s*æ—¥|\s*å¤©)(?:æ—…éŠ|ä¹‹æ—…|è¡Œç¨‹|éŠè¨˜|æ·±åº¦|éŠ|æ”»ç•¥)/i);
        
        // æ¨¡å¼2: æ¨™é¡ŒåŒ¹é…2 - "# æ—¥æœ¬æ—…éŠè¡Œç¨‹"ï¼Œç„¶å¾Œåœ¨å…§å®¹ä¸­å°‹æ‰¾å¤©æ•¸
        if (!titleMatch) {
          titleMatch = content.match(/(?:^|\n)#\s*([^#\n]+?)(?:æ—…éŠ|ä¹‹æ—…|è¡Œç¨‹|éŠè¨˜|æ·±åº¦|éŠ|æ”»ç•¥)/i);
        }
        
        // æ¨¡å¼3: ç›®çš„åœ°èªªæ˜ - "ç›®çš„åœ°: æ—¥æœ¬"
        const destinationMatch = content.match(/(?:ç›®çš„åœ°|æ—…éŠåœ°|åœ°é»|åœ‹å®¶)(?:\s*[ï¼š:]\s*)([^\n,ï¼Œã€]+)/);
        
        // æ¨¡å¼4: å¸¸è¦‹çš„è¡Œç¨‹æ¨™é¡Œ - "ç¬¬ä¸€å¤©: æŠµé”æ±äº¬"ï¼Œå¾ä¸­æå–åœ‹å®¶åŸå¸‚
        const dayMatch = content.match(/ç¬¬ä¸€[å¤©æ—¥](?:\s*[ï¼š:])?\s*æŠµé”([^\n,ï¼Œã€]+)/);
        
        if (titleMatch && titleMatch[1]) {
          let countryName = titleMatch[1].trim();
          // æ¸…ç†æ–‡æœ¬ä¸­å¯èƒ½æœ‰çš„ç‰¹æ®Šç¬¦è™Ÿ
          countryName = countryName.replace(/[ã€ã€‘\[\]ã€Œã€ã€ã€ï¼ˆï¼‰()]/g, '').trim();
          result.country = countryName;
        } else if (destinationMatch && destinationMatch[1]) {
          result.country = destinationMatch[1].trim();
        } else if (dayMatch && dayMatch[1]) {
          // å¾ç¬¬ä¸€å¤©æè¿°ä¸­æå–å¯èƒ½çš„åœ‹å®¶æˆ–åŸå¸‚
          const location = dayMatch[1].trim();
          
          // åŸå¸‚åˆ°åœ‹å®¶çš„æ˜ å°„
          const cityToCountry = {
            'æ±äº¬': 'æ—¥æœ¬', 'å¤§é˜ª': 'æ—¥æœ¬', 'äº¬éƒ½': 'æ—¥æœ¬',
            'é¦–çˆ¾': 'éŸ“åœ‹', 'é‡œå±±': 'éŸ“åœ‹',
            'æ›¼è°·': 'æ³°åœ‹', 'æ™®å‰å³¶': 'æ³°åœ‹', 'æ¸…é‚': 'æ³°åœ‹',
            'å°åŒ—': 'å°ç£', 'é«˜é›„': 'å°ç£',
            'ç´ç´„': 'ç¾åœ‹', 'æ´›æ‰ç£¯': 'ç¾åœ‹', 'èˆŠé‡‘å±±': 'ç¾åœ‹',
            'å·´é»': 'æ³•åœ‹', 'å€«æ•¦': 'è‹±åœ‹', 'ç¾…é¦¬': 'ç¾©å¤§åˆ©',
            'é›ªæ¢¨': 'æ¾³æ´²', 'å¢¨çˆ¾æœ¬': 'æ¾³æ´²',
            'é¦¬å¾·é‡Œ': 'è¥¿ç­ç‰™', 'å·´å¡ç¾…é‚£': 'è¥¿ç­ç‰™',
            'æº«å“¥è¯': 'åŠ æ‹¿å¤§', 'å¤šå€«å¤š': 'åŠ æ‹¿å¤§'
          };
          
          if (cityToCountry[location]) {
            result.country = cityToCountry[location];
          } else {
            // å¯èƒ½ç›´æ¥æ˜¯åœ‹å®¶å
            result.country = location;
          }
        }
        
        // å¦‚æœä»ç„¶æ²’æœ‰æ‰¾åˆ°åœ‹å®¶ï¼Œå˜—è©¦åœ¨æ•´å€‹æ–‡æœ¬ä¸­æœç´¢å¸¸è¦‹åœ‹å®¶åç¨±
        if (!result.country) {
          const commonCountries = [
            'æ—¥æœ¬', 'éŸ“åœ‹', 'æ³°åœ‹', 'å°ç£', 'æ–°åŠ å¡', 'é¦¬ä¾†è¥¿äº', 'è¶Šå—', 
            'å°å°¼', 'è²å¾‹è³“', 'ä¸­åœ‹', 'é¦™æ¸¯', 'æ¾³é–€', 'å°åº¦', 'ç¾åœ‹', 'åŠ æ‹¿å¤§', 
            'å¢¨è¥¿å“¥', 'è‹±åœ‹', 'æ³•åœ‹', 'å¾·åœ‹', 'ç¾©å¤§åˆ©', 'è¥¿ç­ç‰™', 'è‘¡è„ç‰™', 
            'ç‘å£«', 'è·è˜­', 'æ¯”åˆ©æ™‚', 'å¥§åœ°åˆ©', 'å¸Œè‡˜', 'æ¾³æ´²', 'ç´è¥¿è˜­',
            'åŸƒåŠ', 'æ‘©æ´›å“¥', 'å—é'
          ];
          
          // é¦–å…ˆå°‹æ‰¾ "XXXè¡Œç¨‹" æˆ– "XXXæ—…éŠ" æ¨¡å¼
          for (const country of commonCountries) {
            if (content.includes(`${country}è¡Œç¨‹`) || 
                content.includes(`${country}æ—…éŠ`) || 
                content.includes(`${country}ä¹‹æ—…`) ||
                content.match(new RegExp(`${country}\\s*\\d+\\s*å¤©`))) {
              result.country = country;
              break;
            }
          }
          
          // å¦‚æœä»æ‰¾ä¸åˆ°ï¼Œå‰‡å°‹æ‰¾æœ€å¸¸å‡ºç¾çš„åœ‹å®¶åç¨±
          if (!result.country) {
            let maxCount = 0;
            let mostMentioned = null;
            
            for (const country of commonCountries) {
              // å»ºç«‹ä¸€å€‹æ­£å‰‡è¡¨é”å¼ä¾†åŒ¹é…æ•´å€‹å–®è©çš„åœ‹å®¶åç¨±
              const regex = new RegExp(`[^\\w]${country}[^\\w]|^${country}[^\\w]|[^\\w]${country}$|^${country}$`, 'g');
              const matches = content.match(regex);
              const count = matches ? matches.length : 0;
              
              if (count > maxCount) {
                maxCount = count;
                mostMentioned = country;
              }
            }
            
            // åªæœ‰ç•¶åœ‹å®¶åç¨±å‡ºç¾æ¬¡æ•¸è¶³å¤ å¤šæ™‚æ‰æ¡ç”¨
            if (maxCount >= 2) {
              result.country = mostMentioned;
            }
          }
        }
        
        // å˜—è©¦å¾æ–‡æœ¬ä¸­æå–æ—…éŠå¤©æ•¸
        // æ¨¡å¼1: "Xå¤©" ç›´æ¥åŒ¹é…
        const daysMatch1 = content.match(/(?:^|\n)#[^\n]*?(\d+)\s*(?:å¤©|æ—¥)[^\d]/);
        // æ¨¡å¼2: "æ—…éŠå¤©æ•¸: Xå¤©" æ ¼å¼åŒ¹é…
        const daysMatch2 = content.match(/(?:æ—…éŠ|è¡Œç¨‹)(?:å¤©æ•¸|æ—¥æ•¸)(?:\s*[ï¼š:]\\s*)(\d+[\-\+]?\d*)/i);
        // æ¨¡å¼3: "Xæ—¥éŠ" æ ¼å¼åŒ¹é…
        const daysMatch3 = content.match(/(\d+)(?:\s*å¤©|\s*æ—¥)(?:éŠ|è¡Œç¨‹|æ—…è¡Œ|æ—…éŠ)/);
        // æ¨¡å¼4: ç›´æ¥å°‹æ‰¾ "Xå¤©è¡Œç¨‹" æˆ–é¡ä¼¼æ¨¡å¼
        const daysMatch4 = content.match(/(\d+(?:-\d+)?(?:\+)?)(?:\s*å¤©|\s*æ—¥)(?:è¡Œç¨‹|æ—…ç¨‹|æ—…éŠ|éŠç©|éŠè¦½|æ—…è¡Œ)/i);
        
        // æ ¹æ“šåŒ¹é…çµæœç²å–å¤©æ•¸
        if (daysMatch1 && daysMatch1[1]) {
          result.days = daysMatch1[1];
        } else if (daysMatch2 && daysMatch2[1]) {
          result.days = daysMatch2[1];
        } else if (daysMatch3 && daysMatch3[1]) {
          result.days = daysMatch3[1];
        } else if (daysMatch4 && daysMatch4[1]) {
          result.days = daysMatch4[1];
        }
        
        // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°å¤©æ•¸ï¼Œå°‹æ‰¾å¯èƒ½æœ‰çš„æœ€å¾Œä¸€å¤©æ¨™è¨˜
        if (!result.days) {
          // å°‹æ‰¾ "Day X" æˆ– "ç¬¬Xå¤©" çš„æœ€å¤§å€¼
          const dayPattern = /(?:Day|day|ç¬¬)(\d+)(?:å¤©|æ—¥|\s|ï¼š|:)/g;
          let match;
          let maxDay = 0;
          
          while ((match = dayPattern.exec(content)) !== null) {
            const day = parseInt(match[1]);
            if (day > maxDay) maxDay = day;
          }
          
          if (maxDay > 0) {
            result.days = maxDay.toString();
          }
        }
        
        // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°å¤©æ•¸ï¼Œå˜—è©¦åŒ¹é…é è¨­çš„å¤©æ•¸ç¯„åœ
        if (!result.days) {
          if (content.includes('3-5å¤©') || content.includes('3åˆ°5å¤©')) {
            result.days = '3-5';
          } else if (content.includes('6-8å¤©') || content.includes('6åˆ°8å¤©')) {
            result.days = '6-8';
          } else if (content.includes('9-12å¤©') || content.includes('9åˆ°12å¤©')) {
            result.days = '9-12';
          } else if (content.includes('13å¤©ä»¥ä¸Š') || content.includes('å…©é€±') || content.includes('ä¸¤å‘¨')) {
            result.days = '13+';
          }
        }
        
        // å˜—è©¦åˆ¤æ–·åœ°å€
        const regionPatterns = {          'asia': /äºæ´²|æ±äº|æ±å—äº|å—äº/i,
          'europe': /æ­æ´²|è¥¿æ­|æ±æ­|å—æ­|åŒ—æ­/i,
          'america': /ç¾æ´²|åŒ—ç¾|å—ç¾|æ‹‰ä¸ç¾æ´²/i,
          'oceania': /å¤§æ´‹æ´²|æ¾³æ´²/i,
          'africa': /éæ´²/i
        };
        
        for (const [region, pattern] of Object.entries(regionPatterns)) {
          if (pattern.test(content)) {
            result.region = region;
            break;
          }
        }
        
        // å¦‚æœæ²’æœ‰ç›´æ¥æ‰¾åˆ°åœ°å€ï¼Œæ ¹æ“šåœ‹å®¶æ¨æ¸¬åœ°å€
        if (!result.region && result.country) {
          const countryToRegion = {
            'æ—¥æœ¬': 'asia', 'éŸ“åœ‹': 'asia', 'æ³°åœ‹': 'asia', 'å°ç£': 'asia', 'æ–°åŠ å¡': 'asia', 
            'é¦¬ä¾†è¥¿äº': 'asia', 'è¶Šå—': 'asia', 'å°å°¼': 'asia', 'è²å¾‹è³“': 'asia', 'å°åº¦': 'asia',
            'ä¸­åœ‹': 'asia', 'é¦™æ¸¯': 'asia', 'æ¾³é–€': 'asia',
            'è‹±åœ‹': 'europe', 'æ³•åœ‹': 'europe', 'å¾·åœ‹': 'europe', 'ç¾©å¤§åˆ©': 'europe', 
            'è¥¿ç­ç‰™': 'europe', 'è‘¡è„ç‰™': 'europe', 'ç‘å£«': 'europe', 'è·è˜­': 'europe',
            'æ¯”åˆ©æ™‚': 'europe', 'å¥§åœ°åˆ©': 'europe', 'å¸Œè‡˜': 'europe',
            'ç¾åœ‹': 'america', 'åŠ æ‹¿å¤§': 'america', 'å¢¨è¥¿å“¥': 'america',
            'æ¾³æ´²': 'oceania', 'ç´è¥¿è˜­': 'oceania',
            'åŸƒåŠ': 'africa', 'æ‘©æ´›å“¥': 'africa', 'å—é': 'africa'
          };
          
          if (countryToRegion[result.country]) {
            result.region = countryToRegion[result.country];
          }
        }
        
        // å°‹æ‰¾æ—…éŠé¡å‹
        const typePatterns = {
          'family': /å®¶åº­æ—…éŠ|è¦ªå­|å®¶äºº|å¸¶å°å­©/i,
          'honeymoon': /èœœæœˆ|æƒ…ä¾¶|æµªæ¼«/i,
          'adventure': /å†’éšª|æ¢éšª|æ¥µé™|æŒ‘æˆ°|ç™»å±±|æ½›æ°´/i,
          'culture': /æ–‡åŒ–|æ­·å²|å¤è¹Ÿ|è—è¡“|ç¯€æ…¶/i,
          'food': /ç¾é£Ÿ|é¤å»³|æ–™ç†|å°åƒ|é£²é£Ÿ/i
        };
        
        for (const [type, pattern] of Object.entries(typePatterns)) {
          if (pattern.test(content)) {
            result.type = type;
            break;
          }
        }
        
        console.log('å¾è¡Œç¨‹ä¸­æå–çš„è³‡è¨Š:', result);
        return result;
      } catch (error) {
        console.warn('å¾è¡Œç¨‹æå–è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        return result;
      }
    },
    
    // å¾è¡Œç¨‹å…§å®¹æå–æ¯æ—¥è¡Œç¨‹äº®é»
    extractDailyHighlights(content) {
      if (!content) return [];
      
      const dailyHighlights = [];
      const dayPatterns = [
        // åŒ¹é… "ç¬¬Xå¤©ï¼šåœ°é»" æˆ– "ç¬¬Xæ—¥ï¼šåœ°é»" æˆ– "Day Xï¼šåœ°é»" æ ¼å¼
        /(?:ç¬¬\s*(\d+)\s*[å¤©æ—¥]|[Dd]ay\s*(\d+))(?:\s*[ï¼š:]\s*)([^\n]+)/g,
        // åŒ¹é… "Xå¤©ï¼šåœ°é»" æˆ– "Xæ—¥ï¼šåœ°é»" æ ¼å¼
        /(?:(\d+)\s*[å¤©æ—¥])(?:\s*[ï¼š:]\s*)([^\n]+)/g,
        // åŒ¹é… "**ç¬¬Xå¤©ï¼šåœ°é»**" Markdownæ ¼å¼
        /\*\*(?:ç¬¬\s*(\d+)\s*[å¤©æ—¥]|[Dd]ay\s*(\d+))(?:\s*[ï¼š:]\s*)([^\n]+)\*\*/g,
        // åŒ¹é… "### ç¬¬Xå¤©ï¼šåœ°é»" æˆ– "### Day Xï¼šåœ°é»" æ ¼å¼ (Markdownæ¨™é¡Œ)
        /###\s*(?:ç¬¬\s*(\d+)\s*[å¤©æ—¥]|[Dd]ay\s*(\d+))(?:\s*[ï¼š:]\s*)([^\n]+)/g
      ];
      
      // å°æ¯ç¨®æ¨¡å¼å˜—è©¦åŒ¹é…
      for (const pattern of dayPatterns) {
        const matches = [...content.matchAll(pattern)];
        if (matches.length > 0) {
          // é‡ç½®çµæœä¸¦è™•ç†ç•¶å‰åŒ¹é…
          dailyHighlights.length = 0;
          
          for (const match of matches) {
            // æå–æ—¥æœŸå’Œæè¿°
            let day, description;
            if (match[1] !== undefined) {
              day = match[1];
              description = match[3] || match[2]; // ä¸åŒæ ¼å¼çš„æè¿°ä½ç½®ä¸åŒ
            } else if (match[2] !== undefined) {
              day = match[2];
              description = match[3];
            } else {
              continue; // è·³éç„¡æ³•è§£æçš„åŒ¹é…
            }
            
            // æ¸…ç†æè¿°æ–‡æœ¬
            if (description) {
              description = description.trim()
                .replace(/\*\*/g, '') // ç§»é™¤Markdownç²—é«”æ¨™è¨˜
                .replace(/<[^>]+>/g, '') // ç§»é™¤HTMLæ¨™ç±¤
                .trim();
            }
            
            // é™åˆ¶æè¿°é•·åº¦ï¼Œåªä¿ç•™ä¸»è¦åœ°é»
            const shortDescription = description?.split(/[,ï¼Œã€]/)[0] || 'æœªæŒ‡å®š';
            
            dailyHighlights.push({
              day: parseInt(day),
              highlight: shortDescription
            });
          }
          
          // æ‰¾åˆ°æœ‰æ•ˆåŒ¹é…å¾Œï¼ŒæŒ‰å¤©æ•¸æ’åºä¸¦è¿”å›
          if (dailyHighlights.length > 0) {
            return dailyHighlights.sort((a, b) => a.day - b.day);
          }
        }
      }
      
      // å¦‚æœä¸Šè¿°æ¨¡å¼éƒ½æ²’æœ‰åŒ¹é…ï¼Œå°‹æ‰¾æ›´ç°¡å–®çš„æ¨¡å¼
      const simpleDayRegex = /(?:ç¬¬\s*(\d+)\s*[å¤©æ—¥]|[Dd]ay\s*(\d+))[^\n]*/g;
      const simpleMatches = [...content.matchAll(simpleDayRegex)];
      
      if (simpleMatches.length > 0) {
        for (const match of simpleMatches) {
          const day = match[1] || match[2];
          if (!day) continue;
          
          // å˜—è©¦å¾è©²è¡Œæå–é‡è¦åœ°é»
          const line = match[0];
          const location = line.split(/[ï¼š:]/)[1]?.trim() || 
                          line.replace(/(?:ç¬¬\s*\d+\s*[å¤©æ—¥]|[Dd]ay\s*\d+)/, '').trim() ||
                          'æ—¥ç¨‹å®‰æ’';
          
          dailyHighlights.push({
            day: parseInt(day),
            highlight: location
          });
        }
        
        // æ‰¾åˆ°æœ‰æ•ˆåŒ¹é…å¾Œï¼ŒæŒ‰å¤©æ•¸æ’åºä¸¦è¿”å›
        if (dailyHighlights.length > 0) {
          return dailyHighlights.sort((a, b) => a.day - b.day);
        }
      }
      
      return []; // å¦‚æœç„¡æ³•æå–ä»»ä½•æ¯æ—¥è¡Œç¨‹è³‡è¨Š
    },
    
    loadSavedItineraries() {
      // å¾æœ¬åœ°å„²å­˜åŠ è¼‰å·²ä¿å­˜çš„è¡Œç¨‹
      this.savedItineraries = JSON.parse(localStorage.getItem('savedItineraries') || '[]');
      this.showSavedItineraries = true;
    },    loadItinerary(itinerary) {
      // å°‡é¸å®šçš„è¡Œç¨‹è¼‰å…¥åˆ°ç•¶å‰è¦–åœ–
      this.aiResponse = itinerary.content;
      
      // æ›´æ–°å¤©æ•¸è¨ˆç®—å’Œè­¦å‘Šç‹€æ…‹
      this.updateDaysCountAndWarning();
        
      // åŒæ™‚æ›´æ–°è¡¨å–®æ¬„ä½ä»¥ä¾¿èƒ½å¤ å„²å­˜è‡³é›²ç«¯
      if (itinerary.country) {
        this.selectedCountry = itinerary.country;
      }
      
      if (itinerary.days) {
        this.travelDays = itinerary.days;
      }
      
      if (itinerary.region) {
        this.selectedRegion = itinerary.region;
        this.updateCountries(); // æ›´æ–°åœ‹å®¶åˆ—è¡¨
      }
      
      if (itinerary.type) {
        this.travelType = itinerary.type;
      }
      
      // åŠ è¼‰å‡ºç™¼æ—¥æœŸï¼ˆå¦‚æœæœ‰ï¼‰
      if (itinerary.departureDate) {
        this.departureDate = itinerary.departureDate;
      }
      
      // åŠ è¼‰ç‰¹åˆ¥éœ€æ±‚æˆ–åå¥½ï¼ˆå¦‚æœæœ‰ï¼‰
      if (itinerary.specialRequirements) {
        this.specialRequirements = itinerary.specialRequirements;
      }
      
      // å¦‚æœæ²’æœ‰è¡¨å–®æ¬„ä½è³‡è¨Šï¼Œå˜—è©¦å¾å…§å®¹ä¸­æå–
      const missingFields = [];
      let needsExtracting = false;
      
      if (!this.selectedCountry) {
        missingFields.push('åœ‹å®¶');
        needsExtracting = true;
      }
      
      if (!this.travelDays) {
        missingFields.push('æ—…éŠå¤©æ•¸');
        needsExtracting = true;
      }
      
      if (!this.selectedRegion) {
        missingFields.push('å€åŸŸ');
        needsExtracting = true;
      }
      
      if (needsExtracting) {
        const extractedInfo = this.extractInfoFromItinerary(itinerary.content);
        
        if (!this.selectedCountry && extractedInfo.country) {
          this.selectedCountry = extractedInfo.country;
          missingFields = missingFields.filter(field => field !== 'åœ‹å®¶');
        }
        
        if (!this.travelDays && extractedInfo.days) {
          this.travelDays = extractedInfo.days;
          missingFields = missingFields.filter(field => field !== 'æ—…éŠå¤©æ•¸');
        }
        
        if (!this.selectedRegion && extractedInfo.region) {
          this.selectedRegion = extractedInfo.region;
          this.updateCountries(); // æ›´æ–°åœ‹å®¶åˆ—è¡¨
          missingFields = missingFields.filter(field => field !== 'å€åŸŸ');
        }
        
        if (!this.travelType && extractedInfo.type) {
          this.travelType = extractedInfo.type;
        }
      }
      
      // é¡¯ç¤ºæç¤ºè¨Šæ¯
      setTimeout(() => {
        let message = 'è¡Œç¨‹å·²è¼‰å…¥ï¼\n\n';
        
        if (missingFields.length > 0) {
          message += `ç³»çµ±å·²å˜—è©¦è‡ªå‹•å¡«å……å¿…è¦è³‡è¨Šï¼Œä½†ä»ç¼ºå°‘ä»¥ä¸‹æ¬„ä½: ${missingFields.join('ã€')}\n`;
          message += 'è«‹åœ¨è¡¨å–®ä¸­æ‰‹å‹•é¸æ“‡é€™äº›è³‡è¨Šï¼Œä»¥ç¢ºä¿èƒ½å¤ æˆåŠŸå„²å­˜åˆ°é›²ç«¯ã€‚\n\n';
        }
        
        message += 'å¦‚æœæ‚¨å¸Œæœ›å°‡æ­¤è¡Œç¨‹å„²å­˜è‡³é›²ç«¯ä»¥ä¾¿åœ¨ç…§ç‰‡ç‰†ä¸­é—œè¯ï¼Œè«‹é»æ“Š"ç¢ºèªæ¡ç”¨ä¸¦å„²å­˜è‡³é›²ç«¯"æŒ‰éˆ•ã€‚';
        alert(message);
      }, 500);
      
      this.showSavedItineraries = false;
    },
    
    deleteItinerary(id) {
      // åˆªé™¤æŒ‡å®šè¡Œç¨‹
      let savedItineraries = JSON.parse(localStorage.getItem('savedItineraries') || '[]');
      savedItineraries = savedItineraries.filter(item => item.id !== id);
      localStorage.setItem('savedItineraries', JSON.stringify(savedItineraries));
      this.savedItineraries = savedItineraries;
    },

    // è™•ç†è¡¨å–®æäº¤
    handleFormSubmit(event) {
      event.preventDefault();
      
      if (!isAuthenticated.value) {
        this.showLoginPrompt = true;
        // 5ç§’å¾Œè·³è½‰åˆ°ç™»å…¥é é¢
        setTimeout(() => {
          this.router.push('/login?redirect=/advice');
        }, 5000);
        return;
      }
      
      // ç¹¼çºŒç”Ÿæˆè¡Œç¨‹
      this.generateItinerary();
    }
  }
}
</script>

<style scoped>
/* å¯ä»¥æ·»åŠ ä¸€äº›è‡ªå®šç¾©æ¨£å¼ */
.error-message {
  color: #e53e3e;
  margin-top: 1.5rem;
  padding: 0.75rem;
  background-color: #fff5f5;
  border-radius: 0.375rem;
  border: 1px solid #fc8181;
}

/* è¡Œç¨‹å…§å®¹æ¨£å¼ */
.itinerary-content :deep(h2) {
  font-size: 1.5rem;
  font-weight: 400;
  margin-top: 2rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #a7f3d0;
  color: #065f46;
  letter-spacing: -0.025em;
}

.itinerary-content :deep(h3) {
  font-size: 1.25rem;
  font-weight: 500;
  margin-top: 1.75rem;
  margin-bottom: 0.75rem;
  color: #047857;
  letter-spacing: -0.025em;
}

.itinerary-content :deep(strong) {
  font-weight: 500;
  color: #047857;
}

.itinerary-content :deep(li) {
  margin-left: 1.5rem;
  margin-bottom: 0.75rem;
  position: relative;
  color: #4b5563;
}

.itinerary-content :deep(li)::before {
  content: "â€¢";
  position: absolute;
  left: -1rem;
  color: #10b981;
}

.itinerary-content :deep(hr) {
  margin: 2rem 0;
  border-top: 1px solid #d1fae5;
}

.itinerary-content :deep(p) {
  margin-bottom: 1.25rem;
  color: #4b5563;
  line-height: 1.7;
}

.itinerary-content :deep(em) {
  font-style: italic;
  color: #34d399;
}
</style>
